<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE PatternGuards #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 704</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE Unsafe #-}</span><span>
</span><a name="line-7"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-cpp">#ifndef MIN_VERSION_template_haskell</span><span>
</span><a name="line-10"></a><span class="hs-cpp">#define MIN_VERSION_template_haskell(x,y,z) 1</span><span>
</span><a name="line-11"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-12"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Copyright   :  (C) 2008-2016 Edward Kmett, (C) 2015-2016 Ryan Scott</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- License     :  BSD-style (see the file LICENSE)</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- Maintainer  :  Edward Kmett &lt;ekmett@gmail.com&gt;</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-20"></a><span class="hs-comment">--</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- Functions to mechanically derive 'Bifunctor', 'Bifoldable',</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- or 'Bitraversable' instances, or to splice their functions directly into</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- source code. You need to enable the @TemplateHaskell@ language extension</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- in order to use this module.</span><span>
</span><a name="line-25"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bifunctor</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-28"></a><span>    </span><span class="hs-comment">-- * @derive@- functions</span><span>
</span><a name="line-29"></a><span>    </span><span class="hs-comment">-- $derive</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-comment">-- * @make@- functions</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-comment">-- $make</span><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">-- * 'Bifunctor'</span><span>
</span><a name="line-33"></a><span>    </span><a href="Data.Bifunctor.TH.html#deriveBifunctor"><span class="hs-identifier hs-var">deriveBifunctor</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBimap"><span class="hs-identifier hs-var">makeBimap</span></a><span>
</span><a name="line-35"></a><span>    </span><span class="hs-comment">-- * 'Bifoldable'</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#deriveBifoldable"><span class="hs-identifier hs-var">deriveBifoldable</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifold"><span class="hs-identifier hs-var">makeBifold</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifoldMap"><span class="hs-identifier hs-var">makeBifoldMap</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifoldr"><span class="hs-identifier hs-var">makeBifoldr</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifoldl"><span class="hs-identifier hs-var">makeBifoldl</span></a><span>
</span><a name="line-41"></a><span>    </span><span class="hs-comment">-- * 'Bitraversable'</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#deriveBitraversable"><span class="hs-identifier hs-var">deriveBitraversable</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBitraverse"><span class="hs-identifier hs-var">makeBitraverse</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBisequenceA"><span class="hs-identifier hs-var">makeBisequenceA</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBimapM"><span class="hs-identifier hs-var">makeBimapM</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#makeBisequence"><span class="hs-identifier hs-var">makeBisequence</span></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Bifunctor.TH.Internal.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bifunctor</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rights</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,8,0) &amp;&amp; !(MIN_VERSION_template_haskell(2,10,0))</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">foldr'</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">keys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">size</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Lib</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Ppr</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Syntax</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- User-facing API</span><span>
</span><a name="line-66"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">{- $derive

'deriveBifunctor', 'deriveBifoldable', and 'deriveBitraversable' automatically
generate their respective class instances for a given data type, newtype, or data
family instance that has at least two type variable. Examples:

@
&amp;#123;-&amp;#35; LANGUAGE TemplateHaskell &amp;#35;-&amp;#125;
import Data.Bifunctor.TH

data Pair a b = Pair a b
$('deriveBifunctor' ''Pair) -- instance Bifunctor Pair where ...

data WrapLeftPair f g a b = WrapLeftPair (f a) (g a b)
$('deriveBifoldable' ''WrapLeftPair)
-- instance (Foldable f, Bifoldable g) =&gt; Bifoldable (WrapLeftPair f g) where ...
@

If you are using @template-haskell-2.7.0.0@ or later (i.e., GHC 7.4 or later),
the @derive@ functions can be used data family instances (which requires the
@-XTypeFamilies@ extension). To do so, pass the name of a data or newtype instance
constructor (NOT a data family name!) to a @derive@ function.  Note that the
generated code may require the @-XFlexibleInstances@ extension. Example:

@
&amp;#123;-&amp;#35; LANGUAGE FlexibleInstances, TemplateHaskell, TypeFamilies &amp;#35;-&amp;#125;
import Data.Bifunctor.TH

class AssocClass a b c where
    data AssocData a b c
instance AssocClass Int b c where
    data AssocData Int b c = AssocDataInt1 Int | AssocDataInt2 b c
$('deriveBitraversable' 'AssocDataInt1) -- instance Bitraversable (AssocData Int) where ...
-- Alternatively, one could use $(deriveBitraversable 'AssocDataInt2)
@

Note that there are some limitations:

* The 'Name' argument to a @derive@ function must not be a type synonym.

* With a @derive@ function, the last two type variables must both be of kind @*@.
  Other type variables of kind @* -&gt; *@ are assumed to require a 'Functor',
  'Foldable', or 'Traversable' constraint (depending on which @derive@ function is
  used), and other type variables of kind @* -&gt; * -&gt; *@ are assumed to require an
  'Bifunctor', 'Bifoldable', or 'Bitraversable' constraint. If your data type
  doesn't meet these assumptions, use a @make@ function.

* If using the @-XDatatypeContexts@, @-XExistentialQuantification@, or @-XGADTs@
  extensions, a constraint cannot mention either of the last two type variables. For
  example, @data Illegal2 a b where I2 :: Ord a =&gt; a -&gt; b -&gt; Illegal2 a b@ cannot
  have a derived 'Bifunctor' instance.

* If either of the last two type variables is used within a constructor argument's
  type, it must only be used in the last two type arguments. For example,
  @data Legal a b = Legal (Int, Int, a, b)@ can have a derived 'Bifunctor' instance,
  but @data Illegal a b = Illegal (a, b, a, b)@ cannot.

* Data family instances must be able to eta-reduce the last two type variables. In other
  words, if you have a instance of the form:

  @
  data family Family a1 ... an t1 t2
  data instance Family e1 ... e2 v1 v2 = ...
  @

  Then the following conditions must hold:

  1. @v1@ and @v2@ must be distinct type variables.
  2. Neither @v1@ not @v2@ must be mentioned in any of @e1@, ..., @e2@.

-}</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">{- $make

There may be scenarios in which you want to, say, 'bimap' over an arbitrary data type
or data family instance without having to make the type an instance of 'Bifunctor'. For
these cases, this module provides several functions (all prefixed with @make@-) that
splice the appropriate lambda expression into your source code.

This is particularly useful for creating instances for sophisticated data types. For
example, 'deriveBifunctor' cannot infer the correct type context for
@newtype HigherKinded f a b c = HigherKinded (f a b c)@, since @f@ is of kind
@* -&gt; * -&gt; * -&gt; *@. However, it is still possible to create a 'Bifunctor' instance for
@HigherKinded@ without too much trouble using 'makeBimap':

@
&amp;#123;-&amp;#35; LANGUAGE FlexibleContexts, TemplateHaskell &amp;#35;-&amp;#125;
import Data.Bifunctor
import Data.Bifunctor.TH

newtype HigherKinded f a b c = HigherKinded (f a b c)

instance Bifunctor (f a) =&gt; Bifunctor (HigherKinded f a) where
    bimap = $(makeBimap ''HigherKinded)
@

-}</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">-- | Generates a 'Bifunctor' instance declaration for the given data type or data</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- family instance.</span><span>
</span><a name="line-168"></a><span class="hs-identifier">deriveBifunctor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-169"></a><a name="deriveBifunctor"><a href="Data.Bifunctor.TH.html#deriveBifunctor"><span class="hs-identifier">deriveBifunctor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#deriveBiClass"><span class="hs-identifier hs-var">deriveBiClass</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bimap' (without requiring a</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- 'Bifunctor' instance).</span><span>
</span><a name="line-173"></a><span class="hs-identifier">makeBimap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-174"></a><a name="makeBimap"><a href="Data.Bifunctor.TH.html#makeBimap"><span class="hs-identifier">makeBimap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFun"><span class="hs-identifier hs-var">makeBiFun</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-comment">-- | Generates a 'Bifoldable' instance declaration for the given data type or data</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- family instance.</span><span>
</span><a name="line-178"></a><span class="hs-identifier">deriveBifoldable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-179"></a><a name="deriveBifoldable"><a href="Data.Bifunctor.TH.html#deriveBifoldable"><span class="hs-identifier">deriveBifoldable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#deriveBiClass"><span class="hs-identifier hs-var">deriveBiClass</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bifold' (without requiring a</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- 'Bifoldable' instance).</span><span>
</span><a name="line-183"></a><span class="hs-identifier">makeBifold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-184"></a><a name="makeBifold"><a href="Data.Bifunctor.TH.html#makeBifold"><span class="hs-identifier">makeBifold</span></a></a><span> </span><a name="local-1627451203"><a href="#local-1627451203"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifoldMap"><span class="hs-identifier hs-var">makeBifoldMap</span></a><span> </span><a href="#local-1627451203"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-185"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-186"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-187"></a><span>                        </span><span class="hs-special">]</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bifoldMap' (without requiring a</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- 'Bifoldable' instance).</span><span>
</span><a name="line-191"></a><span class="hs-identifier">makeBifoldMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-192"></a><a name="makeBifoldMap"><a href="Data.Bifunctor.TH.html#makeBifoldMap"><span class="hs-identifier">makeBifoldMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFun"><span class="hs-identifier hs-var">makeBiFun</span></a><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bifoldr' (without requiring a</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- 'Bifoldable' instance).</span><span>
</span><a name="line-196"></a><span class="hs-identifier">makeBifoldr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-197"></a><a name="makeBifoldr"><a href="Data.Bifunctor.TH.html#makeBifoldr"><span class="hs-identifier">makeBifoldr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFun"><span class="hs-identifier hs-var">makeBiFun</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bifoldl' (without requiring a</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- 'Bifoldable' instance).</span><span>
</span><a name="line-201"></a><span class="hs-identifier">makeBifoldl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-202"></a><a name="makeBifoldl"><a href="Data.Bifunctor.TH.html#makeBifoldl"><span class="hs-identifier">makeBifoldl</span></a></a><span> </span><a name="local-1627451204"><a href="#local-1627451204"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>  </span><a name="local-1627451207"><a href="#local-1627451207"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;f&quot;</span><span>
</span><a name="line-204"></a><span>  </span><a name="local-1627451208"><a href="#local-1627451208"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;g&quot;</span><span>
</span><a name="line-205"></a><span>  </span><a name="local-1627451209"><a href="#local-1627451209"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-206"></a><span>  </span><a name="local-1627451210"><a href="#local-1627451210"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;t&quot;</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451207"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451208"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451209"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451210"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#appEndoValName"><span class="hs-identifier hs-var">appEndoValName</span></a><span>
</span><a name="line-209"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#getDualValName"><span class="hs-identifier hs-var">getDualValName</span></a><span>
</span><a name="line-210"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><a href="Data.Bifunctor.TH.html#makeBifoldMap"><span class="hs-identifier hs-var">makeBifoldMap</span></a><span> </span><a href="#local-1627451204"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451205"><span class="hs-identifier hs-var">foldFun</span></a><span> </span><a href="#local-1627451207"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451205"><span class="hs-identifier hs-var">foldFun</span></a><span> </span><a href="#local-1627451208"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451210"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span>
</span><a name="line-211"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-212"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451209"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-213"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-214"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-identifier">foldFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-1627451205"><a href="#local-1627451205"><span class="hs-identifier">foldFun</span></a></a><span> </span><a name="local-1627451206"><a href="#local-1627451206"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">infixApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#dualDataName"><span class="hs-identifier hs-var">dualDataName</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#composeValName"><span class="hs-identifier hs-var">composeValName</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">infixApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#endoDataName"><span class="hs-identifier hs-var">endoDataName</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#composeValName"><span class="hs-identifier hs-var">composeValName</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#flipValName"><span class="hs-identifier hs-var">flipValName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451206"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>                         </span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-comment">-- | Generates a 'Bitraversable' instance declaration for the given data type or data</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- family instance.</span><span>
</span><a name="line-225"></a><span class="hs-identifier">deriveBitraversable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-226"></a><a name="deriveBitraversable"><a href="Data.Bifunctor.TH.html#deriveBitraversable"><span class="hs-identifier">deriveBitraversable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#deriveBiClass"><span class="hs-identifier hs-var">deriveBiClass</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier hs-var">Bitraversable</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bitraverse' (without requiring a</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- 'Bitraversable' instance).</span><span>
</span><a name="line-230"></a><span class="hs-identifier">makeBitraverse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-231"></a><a name="makeBitraverse"><a href="Data.Bifunctor.TH.html#makeBitraverse"><span class="hs-identifier">makeBitraverse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFun"><span class="hs-identifier hs-var">makeBiFun</span></a><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bisequenceA' (without requiring a</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- 'Bitraversable' instance).</span><span>
</span><a name="line-235"></a><span class="hs-identifier">makeBisequenceA</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-236"></a><a name="makeBisequenceA"><a href="Data.Bifunctor.TH.html#makeBisequenceA"><span class="hs-identifier">makeBisequenceA</span></a></a><span> </span><a name="local-1627451211"><a href="#local-1627451211"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><a href="Data.Bifunctor.TH.html#makeBitraverse"><span class="hs-identifier hs-var">makeBitraverse</span></a><span> </span><a href="#local-1627451211"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-237"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-238"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-239"></a><span>                             </span><span class="hs-special">]</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bimapM' (without requiring a</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- 'Bitraversable' instance).</span><span>
</span><a name="line-243"></a><span class="hs-identifier">makeBimapM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-244"></a><a name="makeBimapM"><a href="Data.Bifunctor.TH.html#makeBimapM"><span class="hs-identifier">makeBimapM</span></a></a><span> </span><a name="local-1627451212"><a href="#local-1627451212"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-245"></a><span>  </span><a name="local-1627451215"><a href="#local-1627451215"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;f&quot;</span><span>
</span><a name="line-246"></a><span>  </span><a name="local-1627451216"><a href="#local-1627451216"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;g&quot;</span><span>
</span><a name="line-247"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451215"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451216"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">infixApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#unwrapMonadValName"><span class="hs-identifier hs-var">unwrapMonadValName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#composeValName"><span class="hs-identifier hs-var">composeValName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-248"></a><span>                          </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.html#makeBitraverse"><span class="hs-identifier hs-var">makeBitraverse</span></a><span> </span><a href="#local-1627451212"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451213"><span class="hs-identifier hs-var">wrapMonadExp</span></a><span> </span><a href="#local-1627451215"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451213"><span class="hs-identifier hs-var">wrapMonadExp</span></a><span> </span><a href="#local-1627451216"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">]</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-identifier">wrapMonadExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-251"></a><span>    </span><a name="local-1627451213"><a href="#local-1627451213"><span class="hs-identifier">wrapMonadExp</span></a></a><span> </span><a name="local-1627451214"><a href="#local-1627451214"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">infixApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#wrapMonadDataName"><span class="hs-identifier hs-var">wrapMonadDataName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#composeValName"><span class="hs-identifier hs-var">composeValName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451214"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like 'bisequence' (without requiring a</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- 'Bitraversable' instance).</span><span>
</span><a name="line-255"></a><span class="hs-identifier">makeBisequence</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-256"></a><a name="makeBisequence"><a href="Data.Bifunctor.TH.html#makeBisequence"><span class="hs-identifier">makeBisequence</span></a></a><span> </span><a name="local-1627451217"><a href="#local-1627451217"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><span> </span><a href="Data.Bifunctor.TH.html#makeBimapM"><span class="hs-identifier hs-var">makeBimapM</span></a><span> </span><a href="#local-1627451217"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-257"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-258"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#idValName"><span class="hs-identifier hs-var">idValName</span></a><span>
</span><a name="line-259"></a><span>                            </span><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- Code generation</span><span>
</span><a name="line-263"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Derive a class instance declaration (depending on the BiClass argument's value).</span><span>
</span><a name="line-266"></a><span class="hs-identifier">deriveBiClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-267"></a><a name="deriveBiClass"><a href="Data.Bifunctor.TH.html#deriveBiClass"><span class="hs-identifier">deriveBiClass</span></a></a><span> </span><a name="local-1627451218"><a href="#local-1627451218"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451219"><a href="#local-1627451219"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#withType"><span class="hs-identifier hs-var">withType</span></a><span> </span><a href="#local-1627451219"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1627451220"><span class="hs-identifier hs-var">fromCons</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-identifier">fromCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Con</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-269"></a><span>  </span><a name="local-1627451220"><a href="#local-1627451220"><span class="hs-identifier">fromCons</span></a></a><span> </span><a name="local-1627451221"><a href="#local-1627451221"><span class="hs-identifier">name'</span></a></a><span> </span><a name="local-1627451222"><a href="#local-1627451222"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1627451223"><a href="#local-1627451223"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-1627451224"><a href="#local-1627451224"><span class="hs-identifier">cons</span></a></a><span> </span><a name="local-1627451225"><a href="#local-1627451225"><span class="hs-identifier">mbTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-special">(</span><a name="local-1627451226"><a href="#local-1627451226"><span class="hs-identifier">instanceCxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451227"><a href="#local-1627451227"><span class="hs-identifier">instanceType</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.html#buildTypeInstance"><span class="hs-identifier hs-var">buildTypeInstance</span></a><span> </span><a href="#local-1627451218"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451221"><span class="hs-identifier hs-var">name'</span></a><span> </span><a href="#local-1627451222"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451223"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-1627451225"><span class="hs-identifier hs-var">mbTys</span></a><span>
</span><a name="line-272"></a><span>    </span><span class="hs-identifier hs-var">instanceD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-1627451226"><span class="hs-identifier hs-var">instanceCxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-1627451227"><span class="hs-identifier hs-var">instanceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>              </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunDecs"><span class="hs-identifier hs-var">biFunDecs</span></a><span> </span><a href="#local-1627451218"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451224"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- | Generates a declaration defining the primary function(s) corresponding to a</span><span>
</span><a name="line-277"></a><span class="hs-comment">-- particular class (bimap for Bifunctor, bifoldr and bifoldMap for Bifoldable, and</span><span>
</span><a name="line-278"></a><span class="hs-comment">-- bitraverse for Bitraversable).</span><span>
</span><a name="line-279"></a><span class="hs-comment">--</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- For why both bifoldr and bifoldMap are derived for Bifoldable, see Trac #7436.</span><span>
</span><a name="line-281"></a><span class="hs-identifier">biFunDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Con</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-282"></a><a name="biFunDecs"><a href="Data.Bifunctor.TH.html#biFunDecs"><span class="hs-identifier">biFunDecs</span></a></a><span> </span><a name="local-1627451228"><a href="#local-1627451228"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451229"><a href="#local-1627451229"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-1627451230"><span class="hs-identifier hs-var">makeFunD</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biClassToFuns"><span class="hs-identifier hs-var">biClassToFuns</span></a><span> </span><a href="#local-1627451228"><span class="hs-identifier hs-var">biClass</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-identifier">makeFunD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Dec</span><span>
</span><a name="line-284"></a><span>  </span><a name="local-1627451230"><a href="#local-1627451230"><span class="hs-identifier">makeFunD</span></a></a><span> </span><a name="local-1627451231"><a href="#local-1627451231"><span class="hs-identifier">biFun</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-identifier hs-var">funD</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunName"><span class="hs-identifier hs-var">biFunName</span></a><span> </span><a href="#local-1627451231"><span class="hs-identifier hs-var">biFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>         </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">clause</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-287"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFunForCons"><span class="hs-identifier hs-var">makeBiFunForCons</span></a><span> </span><a href="#local-1627451231"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451229"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like the BiFun argument.</span><span>
</span><a name="line-292"></a><span class="hs-identifier">makeBiFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-293"></a><a name="makeBiFun"><a href="Data.Bifunctor.TH.html#makeBiFun"><span class="hs-identifier">makeBiFun</span></a></a><span> </span><a name="local-1627451232"><a href="#local-1627451232"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451233"><a href="#local-1627451233"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#withType"><span class="hs-identifier hs-var">withType</span></a><span> </span><a href="#local-1627451233"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1627451234"><span class="hs-identifier hs-var">fromCons</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-identifier">fromCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Con</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-295"></a><span>  </span><a name="local-1627451234"><a href="#local-1627451234"><span class="hs-identifier">fromCons</span></a></a><span> </span><a name="local-1627451235"><a href="#local-1627451235"><span class="hs-identifier">name'</span></a></a><span> </span><a name="local-1627451236"><a href="#local-1627451236"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1627451237"><a href="#local-1627451237"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-1627451238"><a href="#local-1627451238"><span class="hs-identifier">cons</span></a></a><span> </span><a name="local-1627451239"><a href="#local-1627451239"><span class="hs-identifier">mbTys</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-comment">-- We force buildTypeInstance here since it performs some checks for whether</span><span>
</span><a name="line-297"></a><span>    </span><span class="hs-comment">-- or not the provided datatype can actually have bimap/bifoldr/bitraverse/etc.</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-comment">-- implemented for it, and produces errors if it can't.</span><span>
</span><a name="line-299"></a><span>    </span><a href="Data.Bifunctor.TH.html#buildTypeInstance"><span class="hs-identifier hs-var">buildTypeInstance</span></a><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunToClass"><span class="hs-identifier hs-var">biFunToClass</span></a><span> </span><a href="#local-1627451232"><span class="hs-identifier hs-var">biFun</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451235"><span class="hs-identifier hs-var">name'</span></a><span> </span><a href="#local-1627451236"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451237"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-1627451239"><span class="hs-identifier hs-var">mbTys</span></a><span>
</span><a name="line-300"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFunForCons"><span class="hs-identifier hs-var">makeBiFunForCons</span></a><span> </span><a href="#local-1627451232"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451238"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">-- | Generates a lambda expression for the given constructors.</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- All constructors must be from the same type.</span><span>
</span><a name="line-304"></a><span class="hs-identifier">makeBiFunForCons</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Con</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-305"></a><a name="makeBiFunForCons"><a href="Data.Bifunctor.TH.html#makeBiFunForCons"><span class="hs-identifier">makeBiFunForCons</span></a></a><span> </span><a name="local-1627451240"><a href="#local-1627451240"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451241"><a href="#local-1627451241"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>  </span><a name="local-1627451242"><a href="#local-1627451242"><span class="hs-identifier">argNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;f&quot;</span><span>
</span><a name="line-307"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;g&quot;</span><span>
</span><a name="line-308"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-1627451240"><span class="hs-identifier hs-var">biFun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-309"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;value&quot;</span><span>
</span><a name="line-310"></a><span>                                       </span><span class="hs-special">]</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-1627451243"><a href="#local-1627451243"><span class="hs-identifier">map1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451244"><a href="#local-1627451244"><span class="hs-identifier">map2</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-1627451245"><a href="#local-1627451245"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1627451242"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-312"></a><span>      </span><a name="local-1627451246"><a href="#local-1627451246"><span class="hs-identifier">z</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-1627451245"><span class="hs-identifier hs-var">others</span></a><span> </span><span class="hs-comment">-- If we're deriving bifoldr, this will be well defined</span><span>
</span><a name="line-313"></a><span>                          </span><span class="hs-comment">-- and useful. Otherwise, it'll be ignored.</span><span>
</span><a name="line-314"></a><span>      </span><a name="local-1627451247"><a href="#local-1627451247"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-1627451245"><span class="hs-identifier hs-var">others</span></a><span>
</span><a name="line-315"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451242"><span class="hs-identifier hs-var">argNames</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">appsE</span><span>
</span><a name="line-317"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunConstName"><span class="hs-identifier hs-var">biFunConstName</span></a><span> </span><a href="#local-1627451240"><span class="hs-identifier hs-var">biFun</span></a><span>
</span><a name="line-318"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-1627451241"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-319"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#errorValName"><span class="hs-identifier hs-var">errorValName</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Void &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunName"><span class="hs-identifier hs-var">biFunName</span></a><span> </span><a href="#local-1627451240"><span class="hs-identifier hs-var">biFun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451247"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#makeBiFunForCon"><span class="hs-identifier hs-var">makeBiFunForCon</span></a><span> </span><a href="#local-1627451240"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451246"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-1627451243"><span class="hs-identifier hs-var">map1</span></a><span> </span><a href="#local-1627451244"><span class="hs-identifier hs-var">map2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451241"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451242"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">-- | Generates a lambda expression for a single constructor.</span><span>
</span><a name="line-326"></a><span class="hs-identifier">makeBiFunForCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Con</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Match</span><span>
</span><a name="line-327"></a><a name="makeBiFunForCon"><a href="Data.Bifunctor.TH.html#makeBiFunForCon"><span class="hs-identifier">makeBiFunForCon</span></a></a><span> </span><a name="local-1627451248"><a href="#local-1627451248"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451249"><a href="#local-1627451249"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-1627451250"><a href="#local-1627451250"><span class="hs-identifier">map1</span></a></a><span> </span><a name="local-1627451251"><a href="#local-1627451251"><span class="hs-identifier">map2</span></a></a><span> </span><a name="local-1627451252"><a href="#local-1627451252"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627451253"><a href="#local-1627451253"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#constructorName"><span class="hs-identifier hs-var">constructorName</span></a><span> </span><a href="#local-1627451252"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-329"></a><span>  </span><span class="hs-special">(</span><a name="local-1627451254"><a href="#local-1627451254"><span class="hs-identifier">ts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451255"><a href="#local-1627451255"><span class="hs-identifier">tvMap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.html#reifyConTys"><span class="hs-identifier hs-var">reifyConTys</span></a><span> </span><a href="#local-1627451248"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451253"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451250"><span class="hs-identifier hs-var">map1</span></a><span> </span><a href="#local-1627451251"><span class="hs-identifier hs-var">map2</span></a><span>
</span><a name="line-330"></a><span>  </span><a name="local-1627451256"><a href="#local-1627451256"><span class="hs-identifier">argNames</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#newNameList"><span class="hs-identifier hs-var">newNameList</span></a><span> </span><span class="hs-string">&quot;_arg&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451254"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-331"></a><span>  </span><a href="Data.Bifunctor.TH.html#makeBiFunForArgs"><span class="hs-identifier hs-var">makeBiFunForArgs</span></a><span> </span><a href="#local-1627451248"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451249"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-1627451255"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451253"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451254"><span class="hs-identifier hs-var">ts</span></a><span> </span><a href="#local-1627451256"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-comment">-- | Generates a lambda expression for a single constructor's arguments.</span><span>
</span><a name="line-334"></a><span class="hs-identifier">makeBiFunForArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span>
</span><a name="line-335"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-336"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-337"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-338"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-339"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-340"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Match</span><span>
</span><a name="line-341"></a><a name="makeBiFunForArgs"><a href="Data.Bifunctor.TH.html#makeBiFunForArgs"><span class="hs-identifier">makeBiFunForArgs</span></a></a><span> </span><a name="local-1627451257"><a href="#local-1627451257"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451258"><a href="#local-1627451258"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-1627451259"><a href="#local-1627451259"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451260"><a href="#local-1627451260"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451261"><a href="#local-1627451261"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1627451262"><a href="#local-1627451262"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conP</span><span> </span><a href="#local-1627451260"><span class="hs-identifier hs-var">conName</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451262"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunCombine"><span class="hs-identifier hs-var">biFunCombine</span></a><span> </span><a href="#local-1627451257"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451260"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451258"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-1627451262"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1627451263"><span class="hs-identifier hs-var">mappedArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-345"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-346"></a><span>    </span><span class="hs-identifier">mappedArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-347"></a><span>    </span><a name="local-1627451263"><a href="#local-1627451263"><span class="hs-identifier">mappedArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#makeBiFunForArg"><span class="hs-identifier hs-var">makeBiFunForArg</span></a><span> </span><a href="#local-1627451257"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451259"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451260"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451261"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1627451262"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-comment">-- | Generates a lambda expression for a single argument of a constructor.</span><span>
</span><a name="line-350"></a><span class="hs-comment">--  The returned value is 'Right' if its type mentions one of the last two type</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- parameters. Otherwise, it is 'Left'.</span><span>
</span><a name="line-352"></a><span class="hs-identifier">makeBiFunForArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span>
</span><a name="line-353"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-354"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-355"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-356"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-357"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><a name="makeBiFunForArg"><a href="Data.Bifunctor.TH.html#makeBiFunForArg"><span class="hs-identifier">makeBiFunForArg</span></a></a><span> </span><a name="local-1627451264"><a href="#local-1627451264"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451265"><a href="#local-1627451265"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451266"><a href="#local-1627451266"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451267"><a href="#local-1627451267"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627451268"><a href="#local-1627451268"><span class="hs-identifier">tyExpName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-359"></a><span>  </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451264"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451265"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451266"><span class="hs-identifier hs-var">conName</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627451267"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#appEitherE"><span class="hs-identifier hs-var">appEitherE</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451268"><span class="hs-identifier hs-var">tyExpName</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">-- | Generates a lambda expression for a specific type. The returned value is</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- 'Right' if its type mentions one of the last two type parameters. Otherwise,</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- it is 'Left'.</span><span>
</span><a name="line-364"></a><span class="hs-identifier">makeBiFunForType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span>
</span><a name="line-365"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-366"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-367"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-368"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-369"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><a name="makeBiFunForType"><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier">makeBiFunForType</span></a></a><span> </span><a name="local-1627451269"><a href="#local-1627451269"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451270"><a href="#local-1627451270"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451271"><a href="#local-1627451271"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451272"><a href="#local-1627451272"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarT</span><span> </span><a name="local-1627451273"><a href="#local-1627451273"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-1627451273"><span class="hs-identifier hs-var">tyName</span></a><span> </span><a href="#local-1627451270"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-372"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627451274"><a href="#local-1627451274"><span class="hs-identifier">mapName</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-373"></a><span>                        </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627451272"><span class="hs-identifier hs-var">covariant</span></a><span>
</span><a name="line-374"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627451274"><span class="hs-identifier hs-var">mapName</span></a><span>
</span><a name="line-375"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><a href="Data.Bifunctor.TH.html#contravarianceError"><span class="hs-identifier hs-var">contravarianceError</span></a><span> </span><a href="#local-1627451271"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-376"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunTriv"><span class="hs-identifier hs-var">biFunTriv</span></a><span> </span><a href="#local-1627451269"><span class="hs-identifier hs-var">biFun</span></a><span>
</span><a name="line-377"></a><span class="hs-identifier">makeBiFunForType</span><span> </span><a name="local-1627451275"><a href="#local-1627451275"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451276"><a href="#local-1627451276"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451277"><a href="#local-1627451277"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451278"><a href="#local-1627451278"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigT</span><span> </span><a name="local-1627451279"><a href="#local-1627451279"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-378"></a><span>  </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451275"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451276"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451277"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451278"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-1627451279"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-379"></a><span class="hs-identifier">makeBiFunForType</span><span> </span><a name="local-1627451280"><a href="#local-1627451280"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451281"><a href="#local-1627451281"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451282"><a href="#local-1627451282"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451283"><a href="#local-1627451283"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForallT</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451284"><a href="#local-1627451284"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-380"></a><span>  </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451280"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451281"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451282"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451283"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-1627451284"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-381"></a><span class="hs-identifier">makeBiFunForType</span><span> </span><a name="local-1627451285"><a href="#local-1627451285"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451286"><a href="#local-1627451286"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-1627451287"><a href="#local-1627451287"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451288"><a href="#local-1627451288"><span class="hs-identifier">covariant</span></a></a><span> </span><a name="local-1627451289"><a href="#local-1627451289"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-382"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">tyCon</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-383"></a><span>      </span><span class="hs-identifier">tyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-384"></a><span>      </span><a name="local-1627451290"><a href="#local-1627451290"><span class="hs-identifier">tyCon</span></a></a><span class="hs-glyph">:</span><a name="local-1627451291"><a href="#local-1627451291"><span class="hs-identifier">tyArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#unapplyTy"><span class="hs-identifier hs-var">unapplyTy</span></a><span> </span><a href="#local-1627451289"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span>      </span><span class="hs-identifier">numLastArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-387"></a><span>      </span><a name="local-1627451292"><a href="#local-1627451292"><span class="hs-identifier">numLastArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>      </span><span class="hs-identifier">lhsArgs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rhsArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-390"></a><span>      </span><span class="hs-special">(</span><a name="local-1627451293"><a href="#local-1627451293"><span class="hs-identifier">lhsArgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451294"><a href="#local-1627451294"><span class="hs-identifier">rhsArgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-1627451292"><span class="hs-identifier hs-var">numLastArgs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>      </span><span class="hs-identifier">tyVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-393"></a><span>      </span><a name="local-1627451295"><a href="#local-1627451295"><span class="hs-identifier">tyVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keys</span><span> </span><a href="#local-1627451286"><span class="hs-identifier hs-var">tvMap</span></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span>      </span><span class="hs-identifier">mentionsTyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-396"></a><span>      </span><a name="local-1627451296"><a href="#local-1627451296"><span class="hs-identifier">mentionsTyArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451295"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>      </span><span class="hs-identifier">makeBiFunTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-399"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>      </span><a name="local-1627451297"><a href="#local-1627451297"><span class="hs-identifier">makeBiFunTuple</span></a></a><span> </span><a name="local-1627451299"><a href="#local-1627451299"><span class="hs-identifier">mkTupP</span></a></a><span> </span><a name="local-1627451300"><a href="#local-1627451300"><span class="hs-identifier">mkTupleDataName</span></a></a><span> </span><a name="local-1627451301"><a href="#local-1627451301"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-401"></a><span>        </span><a name="local-1627451302"><a href="#local-1627451302"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-402"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-403"></a><span>                                         </span><span class="hs-special">]</span><span>
</span><a name="line-404"></a><span>        </span><a name="local-1627451303"><a href="#local-1627451303"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#newNameList"><span class="hs-identifier hs-var">newNameList</span></a><span> </span><span class="hs-string">&quot;_tup&quot;</span><span> </span><a href="#local-1627451301"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-1627451304"><a href="#local-1627451304"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-1627451302"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-407"></a><span>            </span><a name="local-1627451305"><a href="#local-1627451305"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-1627451302"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451302"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451304"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><a href="#local-1627451299"><span class="hs-identifier hs-var">mkTupP</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451303"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunCombine"><span class="hs-identifier hs-var">biFunCombine</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span>
</span><a name="line-411"></a><span>                                             </span><span class="hs-special">(</span><a href="#local-1627451300"><span class="hs-identifier hs-var">mkTupleDataName</span></a><span> </span><a href="#local-1627451301"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>                                             </span><a href="#local-1627451305"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-413"></a><span>                                             </span><a href="#local-1627451303"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-414"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="#local-1627451298"><span class="hs-identifier hs-var">makeBiFunTupleField</span></a><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><a href="#local-1627451303"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>                     </span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>                     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-417"></a><span>             </span><span class="hs-special">]</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>      </span><span class="hs-identifier">makeBiFunTupleField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>      </span><a name="local-1627451298"><a href="#local-1627451298"><span class="hs-identifier">makeBiFunTupleField</span></a></a><span> </span><a name="local-1627451306"><a href="#local-1627451306"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-1627451307"><a href="#local-1627451307"><span class="hs-identifier">fieldName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-421"></a><span>        </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451286"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451287"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451288"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-1627451306"><span class="hs-identifier hs-var">fieldTy</span></a><span>
</span><a name="line-422"></a><span>          </span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#appEitherE"><span class="hs-identifier hs-var">appEitherE</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451307"><span class="hs-identifier hs-var">fieldName</span></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451290"><span class="hs-identifier hs-var">tyCon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-425"></a><span>     </span><span class="hs-identifier hs-var">ArrowT</span><span>
</span><a name="line-426"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#allowFunTys"><span class="hs-identifier hs-var">allowFunTys</span></a><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunToClass"><span class="hs-identifier hs-var">biFunToClass</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Bifunctor.TH.html#noFunctionsError"><span class="hs-identifier hs-var">noFunctionsError</span></a><span> </span><a href="#local-1627451287"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-427"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627451296"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1627451310"><a href="#local-1627451310"><span class="hs-identifier">argTy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451311"><a href="#local-1627451311"><span class="hs-identifier">resTy</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627451291"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-428"></a><span>         </span><span class="hs-keyword">do</span><span> </span><a name="local-1627451312"><a href="#local-1627451312"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-429"></a><span>            </span><a name="local-1627451313"><a href="#local-1627451313"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;b&quot;</span><span>
</span><a name="line-430"></a><span>            </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451312"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451313"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-431"></a><span>              </span><a href="#local-1627451308"><span class="hs-identifier hs-var">covBiFun</span></a><span> </span><a href="#local-1627451288"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-1627451311"><span class="hs-identifier hs-var">resTy</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451312"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span>
</span><a name="line-432"></a><span>                </span><span class="hs-special">(</span><a href="#local-1627451308"><span class="hs-identifier hs-var">covBiFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627451288"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451310"><span class="hs-identifier hs-var">argTy</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451313"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-434"></a><span>           </span><span class="hs-identifier">covBiFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-435"></a><span>           </span><a name="local-1627451308"><a href="#local-1627451308"><span class="hs-identifier">covBiFun</span></a></a><span> </span><a name="local-1627451309"><a href="#local-1627451309"><span class="hs-identifier">cov</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#fromEither"><span class="hs-identifier hs-var">fromEither</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451286"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451287"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451309"><span class="hs-identifier hs-var">cov</span></a><span>
</span><a name="line-436"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,6,0)</span><span>
</span><a name="line-437"></a><span>     </span><span class="hs-identifier hs-var">UnboxedTupleT</span><span> </span><a name="local-1627451314"><a href="#local-1627451314"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-438"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627451314"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627451296"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451297"><span class="hs-identifier hs-var">makeBiFunTuple</span></a><span> </span><span class="hs-identifier hs-var">unboxedTupP</span><span> </span><span class="hs-identifier hs-var">unboxedTupleDataName</span><span> </span><a href="#local-1627451314"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-439"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-440"></a><span>     </span><span class="hs-identifier hs-var">TupleT</span><span> </span><a name="local-1627451315"><a href="#local-1627451315"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-441"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627451315"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627451296"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451297"><span class="hs-identifier hs-var">makeBiFunTuple</span></a><span> </span><span class="hs-identifier hs-var">tupP</span><span> </span><span class="hs-identifier hs-var">tupleDataName</span><span> </span><a href="#local-1627451315"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-442"></a><span>     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-443"></a><span>         </span><a name="local-1627451316"><a href="#local-1627451316"><span class="hs-identifier">itf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#isTyFamily"><span class="hs-identifier hs-var">isTyFamily</span></a><span> </span><a href="#local-1627451290"><span class="hs-identifier hs-var">tyCon</span></a><span>
</span><a name="line-444"></a><span>         </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451295"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451293"><span class="hs-identifier hs-var">lhsArgs</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1627451316"><span class="hs-identifier hs-var">itf</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627451296"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>           </span><span class="hs-keyword">then</span><span> </span><a href="Data.Bifunctor.TH.html#outOfPlaceTyVarError"><span class="hs-identifier hs-var">outOfPlaceTyVarError</span></a><span> </span><a href="#local-1627451287"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-446"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451295"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451294"><span class="hs-identifier hs-var">rhsArgs</span></a><span>
</span><a name="line-447"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Bifunctor.TH.html#biFunApp"><span class="hs-identifier hs-var">biFunApp</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-448"></a><span>                         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunArity"><span class="hs-identifier hs-var">biFunArity</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451292"><span class="hs-identifier hs-var">numLastArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>                         </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#fromEither"><span class="hs-identifier hs-var">fromEither</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Bifunctor.TH.html#makeBiFunForType"><span class="hs-identifier hs-var">makeBiFunForType</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span> </span><a href="#local-1627451286"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-1627451287"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-1627451288"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>                                </span><a href="#local-1627451294"><span class="hs-identifier hs-var">rhsArgs</span></a><span>
</span><a name="line-451"></a><span>                         </span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunTriv"><span class="hs-identifier hs-var">biFunTriv</span></a><span> </span><a href="#local-1627451285"><span class="hs-identifier hs-var">biFun</span></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-455"></a><span class="hs-comment">-- Template Haskell reifying and AST manipulation</span><span>
</span><a name="line-456"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-comment">-- | Boilerplate for top level splices.</span><span>
</span><a name="line-459"></a><span class="hs-comment">--</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- The given Name must meet one of two criteria:</span><span>
</span><a name="line-461"></a><span class="hs-comment">--</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- 1. It must be the name of a type constructor of a plain data type or newtype.</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- 2. It must be the name of a data family instance or newtype instance constructor.</span><span>
</span><a name="line-464"></a><span class="hs-comment">--</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- Any other value will result in an exception.</span><span>
</span><a name="line-466"></a><span class="hs-identifier">withType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-467"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Con</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><a href="#local-1627451202"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><a href="#local-1627451202"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-469"></a><a name="withType"><a href="Data.Bifunctor.TH.html#withType"><span class="hs-identifier">withType</span></a></a><span> </span><a name="local-1627451317"><a href="#local-1627451317"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1627451318"><a href="#local-1627451318"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-470"></a><span>  </span><a name="local-1627451320"><a href="#local-1627451320"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reify</span><span> </span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-471"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451320"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-identifier hs-var">TyConI</span><span> </span><a name="local-1627451321"><a href="#local-1627451321"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-473"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451321"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-474"></a><span>        </span><span class="hs-identifier hs-var">DataD</span><span> </span><a name="local-1627451322"><a href="#local-1627451322"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451323"><a href="#local-1627451323"><span class="hs-identifier">tvbs</span></a></a><span>
</span><a name="line-475"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-476"></a><span>              </span><span class="hs-identifier">_</span><span>
</span><a name="line-477"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-478"></a><span>              </span><a name="local-1627451324"><a href="#local-1627451324"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451318"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1627451322"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451323"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-1627451324"><span class="hs-identifier hs-var">cons</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-479"></a><span>        </span><span class="hs-identifier hs-var">NewtypeD</span><span> </span><a name="local-1627451325"><a href="#local-1627451325"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451326"><a href="#local-1627451326"><span class="hs-identifier">tvbs</span></a></a><span>
</span><a name="line-480"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-481"></a><span>                 </span><span class="hs-identifier">_</span><span>
</span><a name="line-482"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-483"></a><span>                 </span><a name="local-1627451327"><a href="#local-1627451327"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451318"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1627451325"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451326"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627451327"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-484"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Unsupported type: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627451321"><span class="hs-identifier hs-var">dec</span></a><span>
</span><a name="line-485"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,7,0)</span><span>
</span><a name="line-486"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-487"></a><span>    </span><span class="hs-identifier hs-var">DataConI</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451328"><a href="#local-1627451328"><span class="hs-identifier">parentName</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-488"></a><span class="hs-cpp"># else</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-identifier">DataConI</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">parentName</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-490"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-491"></a><span>      </span><a name="local-1627451329"><a href="#local-1627451329"><span class="hs-identifier">parentInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reify</span><span> </span><a href="#local-1627451328"><span class="hs-identifier hs-var">parentName</span></a><span>
</span><a name="line-492"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451329"><span class="hs-identifier hs-var">parentInfo</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-493"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-494"></a><span>        </span><span class="hs-identifier hs-var">FamilyI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamilyD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451330"><a href="#local-1627451330"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1627451331"><a href="#local-1627451331"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-495"></a><span class="hs-cpp"># else</span><span>
</span><a name="line-496"></a><span>        </span><span class="hs-identifier">FamilyI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">FamilyD</span><span> </span><span class="hs-identifier">DataFam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">tvbs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">decs</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-497"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-498"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-1627451332"><a href="#local-1627451332"><span class="hs-identifier">instDec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><a href="#local-1627451331"><span class="hs-identifier hs-var">decs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627451333"><a href="#local-1627451333"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451333"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-499"></a><span>                </span><span class="hs-identifier hs-var">DataInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-500"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-501"></a><span>                          </span><span class="hs-identifier">_</span><span>
</span><a name="line-502"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-503"></a><span>                          </span><a name="local-1627451334"><a href="#local-1627451334"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#constructorName"><span class="hs-identifier hs-var">constructorName</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451334"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-504"></a><span>                </span><span class="hs-identifier hs-var">NewtypeInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-505"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-506"></a><span>                             </span><span class="hs-identifier">_</span><span>
</span><a name="line-507"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-508"></a><span>                             </span><a name="local-1627451335"><a href="#local-1627451335"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#constructorName"><span class="hs-identifier hs-var">constructorName</span></a><span> </span><a href="#local-1627451335"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-509"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Must be a data or newtype instance.&quot;</span><span>
</span><a name="line-510"></a><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451332"><span class="hs-identifier hs-var">instDec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-511"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataInstD</span><span> </span><a name="local-1627451336"><a href="#local-1627451336"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451337"><a href="#local-1627451337"><span class="hs-identifier">instTys</span></a></a><span>
</span><a name="line-512"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-513"></a><span>                                </span><span class="hs-identifier">_</span><span>
</span><a name="line-514"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-515"></a><span>                                </span><a name="local-1627451338"><a href="#local-1627451338"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451318"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627451328"><span class="hs-identifier hs-var">parentName</span></a><span> </span><a href="#local-1627451336"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451330"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-1627451338"><span class="hs-identifier hs-var">cons</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627451337"><span class="hs-identifier hs-var">instTys</span></a><span>
</span><a name="line-517"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NewtypeInstD</span><span> </span><a name="local-1627451339"><a href="#local-1627451339"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451340"><a href="#local-1627451340"><span class="hs-identifier">instTys</span></a></a><span>
</span><a name="line-518"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-519"></a><span>                                   </span><span class="hs-identifier">_</span><span>
</span><a name="line-520"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-521"></a><span>                                   </span><a name="local-1627451341"><a href="#local-1627451341"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451318"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627451328"><span class="hs-identifier hs-var">parentName</span></a><span> </span><a href="#local-1627451339"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1627451330"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627451341"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627451340"><span class="hs-identifier hs-var">instTys</span></a><span>
</span><a name="line-523"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-524"></a><span>                  </span><span class="hs-string">&quot;Could not find data or newtype instance constructor.&quot;</span><span>
</span><a name="line-525"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Data constructor &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627451317"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-526"></a><span>          </span><span class="hs-string">&quot; is not from a data family instance constructor.&quot;</span><span>
</span><a name="line-527"></a><span class="hs-cpp"># if MIN_VERSION_template_haskell(2,11,0)</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-identifier hs-var">FamilyI</span><span> </span><span class="hs-identifier hs-var">DataFamilyD</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-529"></a><span class="hs-cpp"># else</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-identifier">FamilyI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">FamilyD</span><span> </span><span class="hs-identifier">DataFam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-531"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-532"></a><span>      </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-533"></a><span>        </span><span class="hs-string">&quot;Cannot use a data family name. Use a data family instance constructor instead.&quot;</span><span>
</span><a name="line-534"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451319"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;The name must be of a plain data type constructor, &quot;</span><span>
</span><a name="line-535"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;or a data family instance constructor.&quot;</span><span>
</span><a name="line-536"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-537"></a><span>    </span><span class="hs-identifier">DataConI</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">dataConIError</span><span>
</span><a name="line-538"></a><span>    </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">ns</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;The name must be of a plain type constructor.&quot;</span><span>
</span><a name="line-539"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-541"></a><span>    </span><span class="hs-identifier">ns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-542"></a><span>    </span><a name="local-1627451319"><a href="#local-1627451319"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Data.Bifunctor.TH.withType: &quot;</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-comment">-- | Deduces the instance context and head for an instance.</span><span>
</span><a name="line-545"></a><span class="hs-identifier">buildTypeInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span>
</span><a name="line-546"></a><span>                  </span><span class="hs-comment">-- ^ Bifunctor, Bifoldable, or Bitraversable</span><span>
</span><a name="line-547"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-548"></a><span>                  </span><span class="hs-comment">-- ^ The type constructor or data family name</span><span>
</span><a name="line-549"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span>
</span><a name="line-550"></a><span>                  </span><span class="hs-comment">-- ^ The datatype context</span><span>
</span><a name="line-551"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBndr</span><span class="hs-special">]</span><span>
</span><a name="line-552"></a><span>                  </span><span class="hs-comment">-- ^ The type variables from the data type/data family declaration</span><span>
</span><a name="line-553"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>                  </span><span class="hs-comment">-- ^ 'Just' the types used to instantiate a data family instance,</span><span>
</span><a name="line-555"></a><span>                  </span><span class="hs-comment">-- or 'Nothing' if it's a plain data type</span><span>
</span><a name="line-556"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Cxt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- Plain data type/newtype case</span><span>
</span><a name="line-558"></a><a name="buildTypeInstance"><a href="Data.Bifunctor.TH.html#buildTypeInstance"><span class="hs-identifier">buildTypeInstance</span></a></a><span> </span><a name="local-1627451342"><a href="#local-1627451342"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451343"><a href="#local-1627451343"><span class="hs-identifier">tyConName</span></a></a><span> </span><a name="local-1627451344"><a href="#local-1627451344"><span class="hs-identifier">dataCxt</span></a></a><span> </span><a name="local-1627451345"><a href="#local-1627451345"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-559"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">varTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-560"></a><span>        </span><a name="local-1627451346"><a href="#local-1627451346"><span class="hs-identifier">varTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#tvbToType"><span class="hs-identifier hs-var">tvbToType</span></a><span> </span><a href="#local-1627451345"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-561"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Data.Bifunctor.TH.html#buildTypeInstanceFromTys"><span class="hs-identifier hs-var">buildTypeInstanceFromTys</span></a><span> </span><a href="#local-1627451342"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451343"><span class="hs-identifier hs-var">tyConName</span></a><span> </span><a href="#local-1627451344"><span class="hs-identifier hs-var">dataCxt</span></a><span> </span><a href="#local-1627451346"><span class="hs-identifier hs-var">varTys</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- Data family instance case</span><span>
</span><a name="line-563"></a><span class="hs-comment">--</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- The CPP is present to work around a couple of annoying old GHC bugs.</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- See Note [Polykinded data families in Template Haskell]</span><span>
</span><a name="line-566"></a><span class="hs-identifier">buildTypeInstance</span><span> </span><a name="local-1627451347"><a href="#local-1627451347"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451348"><a href="#local-1627451348"><span class="hs-identifier">parentName</span></a></a><span> </span><a name="local-1627451349"><a href="#local-1627451349"><span class="hs-identifier">dataCxt</span></a></a><span> </span><a name="local-1627451350"><a href="#local-1627451350"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627451351"><a href="#local-1627451351"><span class="hs-identifier">instTysAndKinds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-567"></a><span class="hs-cpp">#if !(MIN_VERSION_template_haskell(2,8,0)) || MIN_VERSION_template_haskell(2,10,0)</span><span>
</span><a name="line-568"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">instTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-569"></a><span>        </span><a name="local-1627451352"><a href="#local-1627451352"><span class="hs-identifier">instTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#stealKindForType"><span class="hs-identifier hs-var">stealKindForType</span></a><span> </span><a href="#local-1627451350"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-1627451351"><span class="hs-identifier hs-var">instTysAndKinds</span></a><span>
</span><a name="line-570"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-571"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">kindVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Name</span><span class="hs-special">]</span><span>
</span><a name="line-572"></a><span>        </span><span class="hs-identifier">kindVarNames</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nub</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyVarNamesOfType</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">tvbKind</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">tvbs</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>        </span><span class="hs-identifier">numKindVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-575"></a><span>        </span><span class="hs-identifier">numKindVars</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">kindVarNames</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>        </span><span class="hs-identifier">givenKinds</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">givenKinds'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Kind</span><span class="hs-special">]</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-identifier">givenTys</span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Type</span><span class="hs-special">]</span><span>
</span><a name="line-579"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">givenKinds</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">givenTys</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">splitAt</span><span> </span><span class="hs-identifier">numKindVars</span><span> </span><span class="hs-identifier">instTysAndKinds</span><span>
</span><a name="line-580"></a><span>        </span><span class="hs-identifier">givenKinds'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">sanitizeStars</span><span> </span><span class="hs-identifier">givenKinds</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>        </span><span class="hs-comment">-- A GHC 7.6-specific bug requires us to replace all occurrences of</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-comment">-- (ConT GHC.Prim.*) with StarT, or else Template Haskell will reject it.</span><span>
</span><a name="line-584"></a><span>        </span><span class="hs-comment">-- Luckily, (ConT GHC.Prim.*) only seems to occur in this one spot.</span><span>
</span><a name="line-585"></a><span>        </span><span class="hs-identifier">sanitizeStars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Kind</span><span>
</span><a name="line-586"></a><span>        </span><span class="hs-identifier">sanitizeStars</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">go</span><span>
</span><a name="line-587"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-588"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Kind</span><span>
</span><a name="line-589"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">AppT</span><span> </span><span class="hs-identifier">t1</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SigT</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">SigT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">t</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ConT</span><span> </span><span class="hs-identifier">n</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">starKindName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">StarT</span><span>
</span><a name="line-592"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">t</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">t</span><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span>    </span><span class="hs-comment">-- If we run this code with GHC 7.8, we might have to generate extra type</span><span>
</span><a name="line-595"></a><span>    </span><span class="hs-comment">-- variables to compensate for any type variables that Template Haskell</span><span>
</span><a name="line-596"></a><span>    </span><span class="hs-comment">-- eta-reduced away.</span><span>
</span><a name="line-597"></a><span>    </span><span class="hs-comment">-- See Note [Polykinded data families in Template Haskell]</span><span>
</span><a name="line-598"></a><span>    </span><span class="hs-identifier">xTypeNames</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newNameList</span><span> </span><span class="hs-string">&quot;tExtra&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">tvbs</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">givenTys</span><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">xTys</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Type</span><span class="hs-special">]</span><span>
</span><a name="line-601"></a><span>        </span><span class="hs-identifier">xTys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">VarT</span><span> </span><span class="hs-identifier">xTypeNames</span><span>
</span><a name="line-602"></a><span>        </span><span class="hs-comment">-- ^ Because these type variables were eta-reduced away, we can only</span><span>
</span><a name="line-603"></a><span>        </span><span class="hs-comment">--   determine their kind by using stealKindForType. Therefore, we mark</span><span>
</span><a name="line-604"></a><span>        </span><span class="hs-comment">--   them as VarT to ensure they will be given an explicit kind annotation</span><span>
</span><a name="line-605"></a><span>        </span><span class="hs-comment">--   (and so the kind inference machinery has the right information).</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>        </span><span class="hs-identifier">substNamesWithKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Kind</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-608"></a><span>        </span><span class="hs-identifier">substNamesWithKinds</span><span> </span><span class="hs-identifier">nks</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">foldr'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uncurry</span><span> </span><span class="hs-identifier">substNameWithKind</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-identifier">nks</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>        </span><span class="hs-comment">-- The types from the data family instance might not have explicit kind</span><span>
</span><a name="line-611"></a><span>        </span><span class="hs-comment">-- annotations, which the kind machinery needs to work correctly. To</span><span>
</span><a name="line-612"></a><span>        </span><span class="hs-comment">-- compensate, we use stealKindForType to explicitly annotate any</span><span>
</span><a name="line-613"></a><span>        </span><span class="hs-comment">-- types without kind annotations.</span><span>
</span><a name="line-614"></a><span>        </span><span class="hs-identifier">instTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Type</span><span class="hs-special">]</span><span>
</span><a name="line-615"></a><span>        </span><span class="hs-identifier">instTys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">substNamesWithKinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">zip</span><span> </span><span class="hs-identifier">kindVarNames</span><span> </span><span class="hs-identifier">givenKinds'</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>                  </span><span class="hs-comment">-- Note that due to a GHC 7.8-specific bug</span><span>
</span><a name="line-617"></a><span>                  </span><span class="hs-comment">-- (see Note [Polykinded data families in Template Haskell]),</span><span>
</span><a name="line-618"></a><span>                  </span><span class="hs-comment">-- there may be more kind variable names than there are kinds</span><span>
</span><a name="line-619"></a><span>                  </span><span class="hs-comment">-- to substitute. But this is OK! If a kind is eta-reduced, it</span><span>
</span><a name="line-620"></a><span>                  </span><span class="hs-comment">-- means that is was not instantiated to something more specific,</span><span>
</span><a name="line-621"></a><span>                  </span><span class="hs-comment">--   so we need not substitute it. Using stealKindForType will</span><span>
</span><a name="line-622"></a><span>                  </span><span class="hs-comment">--   grab the correct kind.</span><span>
</span><a name="line-623"></a><span>                </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">zipWith</span><span> </span><span class="hs-identifier">stealKindForType</span><span> </span><span class="hs-identifier">tvbs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">givenTys</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">xTys</span><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-625"></a><span>    </span><a href="Data.Bifunctor.TH.html#buildTypeInstanceFromTys"><span class="hs-identifier hs-var">buildTypeInstanceFromTys</span></a><span> </span><a href="#local-1627451347"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451348"><span class="hs-identifier hs-var">parentName</span></a><span> </span><a href="#local-1627451349"><span class="hs-identifier hs-var">dataCxt</span></a><span> </span><a href="#local-1627451352"><span class="hs-identifier hs-var">instTys</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-comment">-- For the given Types, generate an instance context and head. Coming up with</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- the instance type isn't as simple as dropping the last types, as you need to</span><span>
</span><a name="line-629"></a><span class="hs-comment">-- be wary of kinds being instantiated with *.</span><span>
</span><a name="line-630"></a><span class="hs-comment">-- See Note [Type inference in derived instances]</span><span>
</span><a name="line-631"></a><span class="hs-identifier">buildTypeInstanceFromTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span>
</span><a name="line-632"></a><span>                         </span><span class="hs-comment">-- ^ Bifunctor, Bifoldable, or Bitraversable</span><span>
</span><a name="line-633"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-634"></a><span>                         </span><span class="hs-comment">-- ^ The type constructor or data family name</span><span>
</span><a name="line-635"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span>
</span><a name="line-636"></a><span>                         </span><span class="hs-comment">-- ^ The datatype context</span><span>
</span><a name="line-637"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-638"></a><span>                         </span><span class="hs-comment">-- ^ The types to instantiate the instance with</span><span>
</span><a name="line-639"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-640"></a><span>                         </span><span class="hs-comment">-- ^ True if it's a data family, False otherwise</span><span>
</span><a name="line-641"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Cxt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><a name="buildTypeInstanceFromTys"><a href="Data.Bifunctor.TH.html#buildTypeInstanceFromTys"><span class="hs-identifier">buildTypeInstanceFromTys</span></a></a><span> </span><a name="local-1627451353"><a href="#local-1627451353"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451354"><a href="#local-1627451354"><span class="hs-identifier">tyConName</span></a></a><span> </span><a name="local-1627451355"><a href="#local-1627451355"><span class="hs-identifier">dataCxt</span></a></a><span> </span><a name="local-1627451356"><a href="#local-1627451356"><span class="hs-identifier">varTysOrig</span></a></a><span> </span><a name="local-1627451357"><a href="#local-1627451357"><span class="hs-identifier">isDataFamily</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-643"></a><span>    </span><span class="hs-comment">-- Make sure to expand through type/kind synonyms! Otherwise, the</span><span>
</span><a name="line-644"></a><span>    </span><span class="hs-comment">-- eta-reduction check might get tripped up over type variables in a</span><span>
</span><a name="line-645"></a><span>    </span><span class="hs-comment">-- synonym that are actually dropped.</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-comment">-- (See GHC Trac #11416 for a scenario where this actually happened.)</span><span>
</span><a name="line-647"></a><span>    </span><a name="local-1627451358"><a href="#local-1627451358"><span class="hs-identifier">varTysExp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#expandSyn"><span class="hs-identifier hs-var">expandSyn</span></a><span> </span><a href="#local-1627451356"><span class="hs-identifier hs-var">varTysOrig</span></a><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">remainingLength</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-650"></a><span>        </span><a name="local-1627451359"><a href="#local-1627451359"><span class="hs-identifier">remainingLength</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451356"><span class="hs-identifier hs-var">varTysOrig</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span>        </span><span class="hs-identifier">droppedTysExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-653"></a><span>        </span><a name="local-1627451360"><a href="#local-1627451360"><span class="hs-identifier">droppedTysExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-1627451359"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-1627451358"><span class="hs-identifier hs-var">varTysExp</span></a><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span>        </span><span class="hs-identifier">droppedStarKindStati</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.Internal.html#StarKindStatus"><span class="hs-identifier hs-type">StarKindStatus</span></a><span class="hs-special">]</span><span>
</span><a name="line-656"></a><span>        </span><a name="local-1627451361"><a href="#local-1627451361"><span class="hs-identifier">droppedStarKindStati</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#canRealizeKindStar"><span class="hs-identifier hs-var">canRealizeKindStar</span></a><span> </span><a href="#local-1627451360"><span class="hs-identifier hs-var">droppedTysExp</span></a><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span>    </span><span class="hs-comment">-- Check there are enough types to drop and that all of them are either of</span><span>
</span><a name="line-659"></a><span>    </span><span class="hs-comment">-- kind * or kind k (for some kind variable k). If not, throw an error.</span><span>
</span><a name="line-660"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-1627451359"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#NotKindStar"><span class="hs-identifier hs-var">NotKindStar</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451361"><span class="hs-identifier hs-var">droppedStarKindStati</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-661"></a><span>      </span><a href="Data.Bifunctor.TH.html#derivingKindError"><span class="hs-identifier hs-var">derivingKindError</span></a><span> </span><a href="#local-1627451353"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451354"><span class="hs-identifier hs-var">tyConName</span></a><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">droppedKindVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-664"></a><span>        </span><a name="local-1627451362"><a href="#local-1627451362"><span class="hs-identifier">droppedKindVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#catKindVarNames"><span class="hs-identifier hs-var">catKindVarNames</span></a><span> </span><a href="#local-1627451361"><span class="hs-identifier hs-var">droppedStarKindStati</span></a><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span>        </span><span class="hs-comment">-- Substitute kind * for any dropped kind variables</span><span>
</span><a name="line-667"></a><span>        </span><span class="hs-identifier">varTysExpSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-668"></a><span>        </span><a name="local-1627451363"><a href="#local-1627451363"><span class="hs-identifier">varTysExpSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><a href="#local-1627451362"><span class="hs-identifier hs-var">droppedKindVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451358"><span class="hs-identifier hs-var">varTysExp</span></a><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span>        </span><span class="hs-identifier">remainingTysExpSubst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">droppedTysExpSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-671"></a><span>        </span><span class="hs-special">(</span><a name="local-1627451364"><a href="#local-1627451364"><span class="hs-identifier">remainingTysExpSubst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451365"><a href="#local-1627451365"><span class="hs-identifier">droppedTysExpSubst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-672"></a><span>          </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-1627451359"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-1627451363"><span class="hs-identifier hs-var">varTysExpSubst</span></a><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span>        </span><span class="hs-comment">-- All of the type variables mentioned in the dropped types</span><span>
</span><a name="line-675"></a><span>        </span><span class="hs-comment">-- (post-synonym expansion)</span><span>
</span><a name="line-676"></a><span>        </span><span class="hs-identifier">droppedTyVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-677"></a><span>        </span><a name="local-1627451366"><a href="#local-1627451366"><span class="hs-identifier">droppedTyVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#tyVarNamesOfType"><span class="hs-identifier hs-var">tyVarNamesOfType</span></a><span> </span><a href="#local-1627451365"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span>    </span><span class="hs-comment">-- If any of the dropped types were polykinded, ensure that they are of kind *</span><span>
</span><a name="line-680"></a><span>    </span><span class="hs-comment">-- after substituting * for the dropped kind variables. If not, throw an error.</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#hasKindStar"><span class="hs-identifier hs-var">hasKindStar</span></a><span> </span><a href="#local-1627451365"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-682"></a><span>      </span><a href="Data.Bifunctor.TH.html#derivingKindError"><span class="hs-identifier hs-var">derivingKindError</span></a><span> </span><a href="#local-1627451353"><span class="hs-identifier hs-var">biClass</span></a><span> </span><a href="#local-1627451354"><span class="hs-identifier hs-var">tyConName</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">preds</span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Pred</span><span class="hs-special">]</span><span>
</span><a name="line-685"></a><span>        </span><span class="hs-identifier">kvNames</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-686"></a><span>        </span><span class="hs-identifier">kvNames'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-687"></a><span>        </span><span class="hs-comment">-- Derive instance constraints (and any kind variables which are specialized</span><span>
</span><a name="line-688"></a><span>        </span><span class="hs-comment">-- to * in those constraints)</span><span>
</span><a name="line-689"></a><span>        </span><span class="hs-special">(</span><a name="local-1627451367"><a href="#local-1627451367"><span class="hs-identifier">preds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451368"><a href="#local-1627451368"><span class="hs-identifier">kvNames</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#deriveConstraint"><span class="hs-identifier hs-var">deriveConstraint</span></a><span> </span><a href="#local-1627451353"><span class="hs-identifier hs-var">biClass</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451364"><span class="hs-identifier hs-var">remainingTysExpSubst</span></a><span>
</span><a name="line-690"></a><span>        </span><a name="local-1627451369"><a href="#local-1627451369"><span class="hs-identifier">kvNames'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-1627451368"><span class="hs-identifier hs-var">kvNames</span></a><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span>        </span><span class="hs-comment">-- Substitute the kind variables specialized in the constraints with *</span><span>
</span><a name="line-693"></a><span>        </span><span class="hs-identifier">remainingTysExpSubst'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-694"></a><span>        </span><a name="local-1627451370"><a href="#local-1627451370"><span class="hs-identifier">remainingTysExpSubst'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-695"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><a href="#local-1627451369"><span class="hs-identifier hs-var">kvNames'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451364"><span class="hs-identifier hs-var">remainingTysExpSubst</span></a><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span>        </span><span class="hs-comment">-- We now substitute all of the specialized-to-* kind variable names with</span><span>
</span><a name="line-698"></a><span>        </span><span class="hs-comment">-- *, but in the original types, not the synonym-expanded types. The reason</span><span>
</span><a name="line-699"></a><span>        </span><span class="hs-comment">-- we do this is a superficial one: we want the derived instance to resemble</span><span>
</span><a name="line-700"></a><span>        </span><span class="hs-comment">-- the datatype written in source code as closely as possible. For example,</span><span>
</span><a name="line-701"></a><span>        </span><span class="hs-comment">-- for the following data family instance:</span><span>
</span><a name="line-702"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-703"></a><span>        </span><span class="hs-comment">--   data family Fam a</span><span>
</span><a name="line-704"></a><span>        </span><span class="hs-comment">--   newtype instance Fam String = Fam String</span><span>
</span><a name="line-705"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-comment">-- We'd want to generate the instance:</span><span>
</span><a name="line-707"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-708"></a><span>        </span><span class="hs-comment">--   instance C (Fam String)</span><span>
</span><a name="line-709"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-710"></a><span>        </span><span class="hs-comment">-- Not:</span><span>
</span><a name="line-711"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-712"></a><span>        </span><span class="hs-comment">--   instance C (Fam [Char])</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-identifier">remainingTysOrigSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-714"></a><span>        </span><a name="local-1627451371"><a href="#local-1627451371"><span class="hs-identifier">remainingTysOrigSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-715"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">union</span><span> </span><a href="#local-1627451362"><span class="hs-identifier hs-var">droppedKindVarNames</span></a><span> </span><a href="#local-1627451369"><span class="hs-identifier hs-var">kvNames'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-1627451359"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-1627451356"><span class="hs-identifier hs-var">varTysOrig</span></a><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span>        </span><span class="hs-identifier">remainingTysOrigSubst'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-719"></a><span>        </span><span class="hs-comment">-- See Note [Kind signatures in derived instances] for an explanation</span><span>
</span><a name="line-720"></a><span>        </span><span class="hs-comment">-- of the isDataFamily check.</span><span>
</span><a name="line-721"></a><span>        </span><a name="local-1627451372"><a href="#local-1627451372"><span class="hs-identifier">remainingTysOrigSubst'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-722"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627451357"><span class="hs-identifier hs-var">isDataFamily</span></a><span>
</span><a name="line-723"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627451371"><span class="hs-identifier hs-var">remainingTysOrigSubst</span></a><span>
</span><a name="line-724"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#unSigT"><span class="hs-identifier hs-var">unSigT</span></a><span> </span><a href="#local-1627451371"><span class="hs-identifier hs-var">remainingTysOrigSubst</span></a><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span>        </span><span class="hs-identifier">instanceCxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span>
</span><a name="line-727"></a><span>        </span><a name="local-1627451373"><a href="#local-1627451373"><span class="hs-identifier">instanceCxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-1627451367"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>        </span><span class="hs-identifier">instanceType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-730"></a><span>        </span><a name="local-1627451374"><a href="#local-1627451374"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biClassName"><span class="hs-identifier hs-var">biClassName</span></a><span> </span><a href="#local-1627451353"><span class="hs-identifier hs-var">biClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#applyTyCon"><span class="hs-identifier hs-var">applyTyCon</span></a><span> </span><a href="#local-1627451354"><span class="hs-identifier hs-var">tyConName</span></a><span> </span><a href="#local-1627451372"><span class="hs-identifier hs-var">remainingTysOrigSubst'</span></a><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>    </span><span class="hs-comment">-- If the datatype context mentions any of the dropped type variables,</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-comment">-- we can't derive an instance, so throw an error.</span><span>
</span><a name="line-735"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#predMentionsName"><span class="hs-identifier hs-var">predMentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451366"><span class="hs-identifier hs-var">droppedTyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451355"><span class="hs-identifier hs-var">dataCxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-736"></a><span>      </span><a href="Data.Bifunctor.TH.html#datatypeContextError"><span class="hs-identifier hs-var">datatypeContextError</span></a><span> </span><a href="#local-1627451354"><span class="hs-identifier hs-var">tyConName</span></a><span> </span><a href="#local-1627451374"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-737"></a><span>    </span><span class="hs-comment">-- Also ensure the dropped types can be safely eta-reduced. Otherwise,</span><span>
</span><a name="line-738"></a><span>    </span><span class="hs-comment">-- throw an error.</span><span>
</span><a name="line-739"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#canEtaReduce"><span class="hs-identifier hs-var">canEtaReduce</span></a><span> </span><a href="#local-1627451370"><span class="hs-identifier hs-var">remainingTysExpSubst'</span></a><span> </span><a href="#local-1627451365"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-740"></a><span>      </span><a href="Data.Bifunctor.TH.html#etaReductionError"><span class="hs-identifier hs-var">etaReductionError</span></a><span> </span><a href="#local-1627451374"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-741"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1627451373"><span class="hs-identifier hs-var">instanceCxt</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451374"><span class="hs-identifier hs-var">instanceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">-- | Attempt to derive a constraint on a Type. If successful, return</span><span>
</span><a name="line-744"></a><span class="hs-comment">-- Just the constraint and any kind variable names constrained to *.</span><span>
</span><a name="line-745"></a><span class="hs-comment">-- Otherwise, return Nothing and the empty list.</span><span>
</span><a name="line-746"></a><span class="hs-comment">--</span><span>
</span><a name="line-747"></a><span class="hs-comment">-- See Note [Type inference in derived instances] for the heuristics used to</span><span>
</span><a name="line-748"></a><span class="hs-comment">-- come up with constraints.</span><span>
</span><a name="line-749"></a><span class="hs-identifier">deriveConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Pred</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-750"></a><a name="deriveConstraint"><a href="Data.Bifunctor.TH.html#deriveConstraint"><span class="hs-identifier">deriveConstraint</span></a></a><span> </span><a name="local-1627451504"><a href="#local-1627451504"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451505"><a href="#local-1627451505"><span class="hs-identifier">t</span></a></a><span>
</span><a name="line-751"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627451505"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#hasKindVarChain"><span class="hs-identifier hs-var">hasKindVarChain</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-1627451505"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-753"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627451507"><a href="#local-1627451507"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#applyClass"><span class="hs-identifier hs-var">applyClass</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451506"><span class="hs-identifier hs-var">tName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Data.Bifunctor.TH.html#biClassConstraint"><span class="hs-identifier hs-var">biClassConstraint</span></a><span> </span><a href="#local-1627451504"><span class="hs-identifier hs-var">biClass</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-1627451507"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#hasKindVarChain"><span class="hs-identifier hs-var">hasKindVarChain</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1627451505"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-755"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627451508"><a href="#local-1627451508"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#applyClass"><span class="hs-identifier hs-var">applyClass</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627451506"><span class="hs-identifier hs-var">tName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Data.Bifunctor.TH.html#biClassConstraint"><span class="hs-identifier hs-var">biClassConstraint</span></a><span> </span><a href="#local-1627451504"><span class="hs-identifier hs-var">biClass</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><a href="#local-1627451508"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-identifier">tName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-759"></a><span>    </span><a name="local-1627451506"><a href="#local-1627451506"><span class="hs-identifier">tName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#varTToName"><span class="hs-identifier hs-var">varTToName</span></a><span> </span><a href="#local-1627451505"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-760"></a><span>
</span><a name="line-761"></a><span class="hs-comment">{-
Note [Polykinded data families in Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In order to come up with the correct instance context and head for an instance, e.g.,

  instance C a =&gt; C (Data a) where ...

We need to know the exact types and kinds used to instantiate the instance. For
plain old datatypes, this is simple: every type must be a type variable, and
Template Haskell reliably tells us the type variables and their kinds.

Doing the same for data families proves to be much harder for three reasons:

1. On any version of Template Haskell, it may not tell you what an instantiated
   type's kind is. For instance, in the following data family instance:

     data family Fam (f :: * -&gt; *) (a :: *)
     data instance Fam f a

   Then if we use TH's reify function, it would tell us the TyVarBndrs of the
   data family declaration are:

     [KindedTV f (AppT (AppT ArrowT StarT) StarT),KindedTV a StarT]

   and the instantiated types of the data family instance are:

     [VarT f1,VarT a1]

   We can't just pass [VarT f1,VarT a1] to buildTypeInstanceFromTys, since we
   have no way of knowing their kinds. Luckily, the TyVarBndrs tell us what the
   kind is in case an instantiated type isn't a SigT, so we use the stealKindForType
   function to ensure all of the instantiated types are SigTs before passing them
   to buildTypeInstanceFromTys.
2. On GHC 7.6 and 7.8, a bug is present in which Template Haskell lists all of
   the specified kinds of a data family instance efore any of the instantiated
   types. Fortunately, this is easy to deal with: you simply count the number of
   distinct kind variables in the data family declaration, take that many elements
   from the front of the  Types list of the data family instance, substitute the
   kind variables with their respective instantiated kinds (which you took earlier),
   and proceed as normal.
3. On GHC 7.8, an even uglier bug is present (GHC Trac #9692) in which Template
   Haskell might not even list all of the Types of a data family instance, since
   they are eta-reduced away! And yes, kinds can be eta-reduced too.

   The simplest workaround is to count how many instantiated types are missing from
   the list and generate extra type variables to use in their place. Luckily, we
   needn't worry much if its kind was eta-reduced away, since using stealKindForType
   will get it back.

Note [Kind signatures in derived instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

It is possible to put explicit kind signatures into the derived instances, e.g.,

  instance C a =&gt; C (Data (f :: * -&gt; *)) where ...

But it is preferable to avoid this if possible. If we come up with an incorrect
kind signature (which is entirely possible, since our type inferencer is pretty
unsophisticated - see Note [Type inference in derived instances]), then GHC will
flat-out reject the instance, which is quite unfortunate.

Plain old datatypes have the advantage that you can avoid using any kind signatures
at all in their instances. This is because a datatype declaration uses all type
variables, so the types that we use in a derived instance uniquely determine their
kinds. As long as we plug in the right types, the kind inferencer can do the rest
of the work. For this reason, we use unSigT to remove all kind signatures before
splicing in the instance context and head.

Data family instances are trickier, since a data family can have two instances that
are distinguished by kind alone, e.g.,

  data family Fam (a :: k)
  data instance Fam (a :: * -&gt; *)
  data instance Fam (a :: *)

If we dropped the kind signatures for C (Fam a), then GHC will have no way of
knowing which instance we are talking about. To avoid this scenario, we always
include explicit kind signatures in data family instances. There is a chance that
the inferred kind signatures will be incorrect, but if so, we can always fall back
on the make- functions.

Note [Type inference in derived instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Type inference is can be tricky to get right, and we want to avoid recreating the
entirety of GHC's type inferencer in Template Haskell. For this reason, we will
probably never come up with derived instance contexts that are as accurate as
GHC's. But that doesn't mean we can't do anything! There are a couple of simple
things we can do to make instance contexts that work for 80% of use cases:

1. If one of the last type parameters is polykinded, then its kind will be
   specialized to * in the derived instance. We note what kind variable the type
   parameter had and substitute it with * in the other types as well. For example,
   imagine you had

     data Data (a :: k) (b :: k) (c :: k)

   Then you'd want to derived instance to be:

     instance C (Data (a :: *))

   Not:

     instance C (Data (a :: k))

2. We na&#239;vely come up with instance constraints using the following criteria:

   (i)  If there's a type parameter n of kind k1 -&gt; k2 (where k1/k2 are * or kind
        variables), then generate a Functor n constraint, and if k1/k2 are kind
        variables, then substitute k1/k2 with * elsewhere in the types. We must
        consider the case where they are kind variables because you might have a
        scenario like this:

          newtype Compose (f :: k3 -&gt; *) (g :: k1 -&gt; k2 -&gt; k3) (a :: k1) (b :: k2)
            = Compose (f (g a b))

        Which would have a derived Bifunctor instance of:

          instance (Functor f, Bifunctor g) =&gt; Bifunctor (Compose f g) where ...
   (ii) If there's a type parameter n of kind k1 -&gt; k2 -&gt; k3 (where k1/k2/k3 are
        * or kind variables), then generate a Bifunctor n constraint and perform
        kind substitution as in the other case.
-}</span><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span class="hs-comment">-- Determines the types of a constructor's arguments as well as the last type</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- parameters (along with their map functions), expanding through any type synonyms.</span><span>
</span><a name="line-888"></a><span class="hs-comment">-- The type parameters are determined on a constructor-by-constructor basis since</span><span>
</span><a name="line-889"></a><span class="hs-comment">-- they may be refined to be particular types in a GADT.</span><span>
</span><a name="line-890"></a><span class="hs-identifier">reifyConTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span>
</span><a name="line-891"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-892"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-893"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-894"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-895"></a><a name="reifyConTys"><a href="Data.Bifunctor.TH.html#reifyConTys"><span class="hs-identifier">reifyConTys</span></a></a><span> </span><a name="local-1627451509"><a href="#local-1627451509"><span class="hs-identifier">biFun</span></a></a><span> </span><a name="local-1627451510"><a href="#local-1627451510"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-1627451511"><a href="#local-1627451511"><span class="hs-identifier">map1</span></a></a><span> </span><a name="local-1627451512"><a href="#local-1627451512"><span class="hs-identifier">map2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-896"></a><span>    </span><a name="local-1627451513"><a href="#local-1627451513"><span class="hs-identifier">info</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reify</span><span> </span><a href="#local-1627451510"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-897"></a><span>    </span><span class="hs-special">(</span><a name="local-1627451515"><a href="#local-1627451515"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451516"><a href="#local-1627451516"><span class="hs-identifier">uncTy</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627451513"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-898"></a><span>        </span><span class="hs-identifier hs-var">DataConI</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451514"><a href="#local-1627451514"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-899"></a><span class="hs-cpp">#if !(MIN_VERSION_template_haskell(2,11,0))</span><span>
</span><a name="line-900"></a><span>                 </span><span class="hs-identifier">_</span><span>
</span><a name="line-901"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-902"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#uncurryTy"><span class="hs-identifier hs-var">uncurryTy</span></a><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.Internal.html#expandSyn"><span class="hs-identifier hs-var">expandSyn</span></a><span> </span><a href="#local-1627451514"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Must be a data constructor&quot;</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627451517"><a href="#local-1627451517"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1627451518"><a href="#local-1627451518"><span class="hs-identifier">resTy</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451516"><span class="hs-identifier hs-var">uncTy</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627451516"><span class="hs-identifier hs-var">uncTy</span></a><span>
</span><a name="line-905"></a><span>        </span><a name="local-1627451519"><a href="#local-1627451519"><span class="hs-identifier">unapResTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#unapplyTy"><span class="hs-identifier hs-var">unapplyTy</span></a><span> </span><a href="#local-1627451518"><span class="hs-identifier hs-var">resTy</span></a><span>
</span><a name="line-906"></a><span>        </span><span class="hs-comment">-- If one of the last type variables is refined to a particular type</span><span>
</span><a name="line-907"></a><span>        </span><span class="hs-comment">-- (i.e., not truly polymorphic), we mark it with Nothing and filter</span><span>
</span><a name="line-908"></a><span>        </span><span class="hs-comment">-- it out later, since we only apply map functions to arguments of</span><span>
</span><a name="line-909"></a><span>        </span><span class="hs-comment">-- a type that it (1) one of the last type variables, and (2)</span><span>
</span><a name="line-910"></a><span>        </span><span class="hs-comment">-- of a truly polymorphic type.</span><span>
</span><a name="line-911"></a><span>        </span><a name="local-1627451520"><a href="#local-1627451520"><span class="hs-identifier">mbTvNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#varTToName_maybe"><span class="hs-identifier hs-var">varTToName_maybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-912"></a><span>                        </span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451519"><span class="hs-identifier hs-var">unapResTy</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-1627451519"><span class="hs-identifier hs-var">unapResTy</span></a><span>
</span><a name="line-913"></a><span>        </span><span class="hs-comment">-- We use Map.fromList to ensure that if there are any duplicate type</span><span>
</span><a name="line-914"></a><span>        </span><span class="hs-comment">-- variables (as can happen in a GADT), the rightmost type variable gets</span><span>
</span><a name="line-915"></a><span>        </span><span class="hs-comment">-- associated with the map function.</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-917"></a><span>        </span><span class="hs-comment">-- See Note [Matching functions with GADT type variables]</span><span>
</span><a name="line-918"></a><span>        </span><a name="local-1627451521"><a href="#local-1627451521"><span class="hs-identifier">tvMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span>
</span><a name="line-919"></a><span>                    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-comment">-- Drop refined types</span><span>
</span><a name="line-920"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627451522"><a href="#local-1627451522"><span class="hs-identifier">mbTvName</span></a></a><span> </span><a name="local-1627451523"><a href="#local-1627451523"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-921"></a><span>                                  </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627451524"><a href="#local-1627451524"><span class="hs-identifier">tvName</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627451524"><span class="hs-identifier hs-var">tvName</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451523"><span class="hs-identifier hs-var">sp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627451522"><span class="hs-identifier hs-var">mbTvName</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>                              </span><a href="#local-1627451520"><span class="hs-identifier hs-var">mbTvNames</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627451511"><span class="hs-identifier hs-var">map1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451512"><span class="hs-identifier hs-var">map2</span></a><span class="hs-special">]</span><span>
</span><a name="line-923"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Bifunctor.TH.Internal.html#predMentionsName"><span class="hs-identifier hs-var">predMentionsName</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keys</span><span> </span><a href="#local-1627451521"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451515"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-924"></a><span>         </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">size</span><span> </span><a href="#local-1627451521"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>         </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#allowExQuant"><span class="hs-identifier hs-var">allowExQuant</span></a><span> </span><span class="hs-special">(</span><a href="Data.Bifunctor.TH.html#biFunToClass"><span class="hs-identifier hs-var">biFunToClass</span></a><span> </span><a href="#local-1627451509"><span class="hs-identifier hs-var">biFun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="Data.Bifunctor.TH.html#existentialContextError"><span class="hs-identifier hs-var">existentialContextError</span></a><span> </span><a href="#local-1627451510"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-927"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1627451517"><span class="hs-identifier hs-var">argTys</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627451521"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span class="hs-comment">{-
Note [Matching functions with GADT type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When deriving Bifoldable, there is a tricky corner case to consider:

  data Both a b where
    BothCon :: x -&gt; x -&gt; Both x x

Which fold functions should be applied to which arguments of BothCon? We have a
choice, since both the function of type (a -&gt; m) and of type (b -&gt; m) can be
applied to either argument. In such a scenario, the second fold function takes
precedence over the first fold function, so the derived Bifoldable instance would be:

  instance Bifoldable Both where
    bifoldMap _ g (BothCon x1 x2) = g x1 &lt;&gt; g x2

This is not an arbitrary choice, as this definition ensures that
bifoldMap id = Foldable.foldMap for a derived Bifoldable instance for Both.
-}</span><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-951"></a><span class="hs-comment">-- Error messages</span><span>
</span><a name="line-952"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span class="hs-comment">-- | Either the given data type doesn't have enough type variables, or one of</span><span>
</span><a name="line-955"></a><span class="hs-comment">-- the type variables to be eta-reduced cannot realize kind *.</span><span>
</span><a name="line-956"></a><span class="hs-identifier">derivingKindError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451201"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-957"></a><a name="derivingKindError"><a href="Data.Bifunctor.TH.html#derivingKindError"><span class="hs-identifier">derivingKindError</span></a></a><span> </span><a name="local-1627451525"><a href="#local-1627451525"><span class="hs-identifier">biClass</span></a></a><span> </span><a name="local-1627451526"><a href="#local-1627451526"><span class="hs-identifier">tyConName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-958"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Cannot derive well-kinded instance of form &#8216;&quot;</span><span>
</span><a name="line-959"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><a href="#local-1627451527"><span class="hs-identifier hs-var">className</span></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showChar</span><span> </span><span class="hs-char">' '</span><span>
</span><a name="line-961"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showParen</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-962"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451526"><span class="hs-identifier hs-var">tyConName</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; ...&quot;</span><span>
</span><a name="line-964"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-965"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216;\n\tClass &quot;</span><span>
</span><a name="line-966"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><a href="#local-1627451527"><span class="hs-identifier hs-var">className</span></a><span>
</span><a name="line-967"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; expects an argument of kind * -&gt; * -&gt; *&quot;</span><span>
</span><a name="line-968"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-969"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-970"></a><span>    </span><span class="hs-identifier">className</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-971"></a><span>    </span><a name="local-1627451527"><a href="#local-1627451527"><span class="hs-identifier">className</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biClassName"><span class="hs-identifier hs-var">biClassName</span></a><span> </span><a href="#local-1627451525"><span class="hs-identifier hs-var">biClass</span></a><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span class="hs-comment">-- | One of the last two type variables appeard in a contravariant position</span><span>
</span><a name="line-974"></a><span class="hs-comment">-- when deriving Bifoldable or Bitraversable.</span><span>
</span><a name="line-975"></a><span class="hs-identifier">contravarianceError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451200"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-976"></a><a name="contravarianceError"><a href="Data.Bifunctor.TH.html#contravarianceError"><span class="hs-identifier">contravarianceError</span></a></a><span> </span><a name="local-1627451528"><a href="#local-1627451528"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-977"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-978"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451528"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must not use the last type variable(s) in a function argument&quot;</span><span>
</span><a name="line-980"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span class="hs-comment">-- | A constructor has a function argument in a derived Bifoldable or Bitraversable</span><span>
</span><a name="line-983"></a><span class="hs-comment">-- instance.</span><span>
</span><a name="line-984"></a><span class="hs-identifier">noFunctionsError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451199"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-985"></a><a name="noFunctionsError"><a href="Data.Bifunctor.TH.html#noFunctionsError"><span class="hs-identifier">noFunctionsError</span></a></a><span> </span><a name="local-1627451529"><a href="#local-1627451529"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-986"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-987"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451529"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must not contain function types&quot;</span><span>
</span><a name="line-989"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-comment">-- | The data type has a DatatypeContext which mentions one of the eta-reduced</span><span>
</span><a name="line-992"></a><span class="hs-comment">-- type variables.</span><span>
</span><a name="line-993"></a><span class="hs-identifier">datatypeContextError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451198"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-994"></a><a name="datatypeContextError"><a href="Data.Bifunctor.TH.html#datatypeContextError"><span class="hs-identifier">datatypeContextError</span></a></a><span> </span><a name="local-1627451530"><a href="#local-1627451530"><span class="hs-identifier">dataName</span></a></a><span> </span><a name="local-1627451531"><a href="#local-1627451531"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-995"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Can't make a derived instance of &#8216;&quot;</span><span>
</span><a name="line-996"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprint</span><span> </span><a href="#local-1627451531"><span class="hs-identifier hs-var">instanceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216;:\n\tData type &#8216;&quot;</span><span>
</span><a name="line-998"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451530"><span class="hs-identifier hs-var">dataName</span></a><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must not have a class context involving the last type argument(s)&quot;</span><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1001"></a><span>
</span><a name="line-1002"></a><span class="hs-comment">-- | The data type has an existential constraint which mentions one of the</span><span>
</span><a name="line-1003"></a><span class="hs-comment">-- eta-reduced type variables.</span><span>
</span><a name="line-1004"></a><span class="hs-identifier">existentialContextError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451197"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1005"></a><a name="existentialContextError"><a href="Data.Bifunctor.TH.html#existentialContextError"><span class="hs-identifier">existentialContextError</span></a></a><span> </span><a name="local-1627451532"><a href="#local-1627451532"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451532"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must be truly polymorphic in the last argument(s) of the data type&quot;</span><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-comment">-- | The data type mentions one of the n eta-reduced type variables in a place other</span><span>
</span><a name="line-1012"></a><span class="hs-comment">-- than the last nth positions of a data type in a constructor's field.</span><span>
</span><a name="line-1013"></a><span class="hs-identifier">outOfPlaceTyVarError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451196"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1014"></a><a name="outOfPlaceTyVarError"><a href="Data.Bifunctor.TH.html#outOfPlaceTyVarError"><span class="hs-identifier">outOfPlaceTyVarError</span></a></a><span> </span><a name="local-1627451533"><a href="#local-1627451533"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-1015"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-1016"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1627451533"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-1017"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must only use its last two type variable(s) within&quot;</span><span>
</span><a name="line-1018"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; the last two argument(s) of a data type&quot;</span><span>
</span><a name="line-1019"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1020"></a><span>
</span><a name="line-1021"></a><span class="hs-comment">-- | One of the last type variables cannot be eta-reduced (see the canEtaReduce</span><span>
</span><a name="line-1022"></a><span class="hs-comment">-- function for the criteria it would have to meet).</span><span>
</span><a name="line-1023"></a><span class="hs-identifier">etaReductionError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627451195"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1024"></a><a name="etaReductionError"><a href="Data.Bifunctor.TH.html#etaReductionError"><span class="hs-identifier">etaReductionError</span></a></a><span> </span><a name="local-1627451534"><a href="#local-1627451534"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1025"></a><span>  </span><span class="hs-string">&quot;Cannot eta-reduce to an instance of form \n\tinstance (...) =&gt; &quot;</span><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">pprint</span><span> </span><a href="#local-1627451534"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span class="hs-cpp">#if !(MIN_VERSION_template_haskell(2,7,0))</span><span>
</span><a name="line-1029"></a><span class="hs-comment">-- | Template Haskell didn't list all of a data family's instances upon reification</span><span>
</span><a name="line-1030"></a><span class="hs-comment">-- until template-haskell-2.7.0.0, which is necessary for a derived instance to work.</span><span>
</span><a name="line-1031"></a><span class="hs-identifier">dataConIError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-1032"></a><span class="hs-identifier">dataConIError</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span>
</span><a name="line-1033"></a><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;Cannot use a data constructor.&quot;</span><span>
</span><a name="line-1034"></a><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;\n\t(Note: if you are trying to derive for a data family instance,&quot;</span><span>
</span><a name="line-1035"></a><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;\n\tuse GHC &gt;= 7.4 instead.)&quot;</span><span>
</span><a name="line-1036"></a><span>  </span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1037"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-1040"></a><span class="hs-comment">-- Class-specific constants</span><span>
</span><a name="line-1041"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-1042"></a><span>
</span><a name="line-1043"></a><span class="hs-comment">-- | A representation of which class is being derived.</span><span>
</span><a name="line-1044"></a><span class="hs-keyword">data</span><span> </span><a name="BiClass"><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier">BiClass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Bifunctor"><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier">Bifunctor</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Bifoldable"><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier">Bifoldable</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Bitraversable"><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier">Bitraversable</span></a></a><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span class="hs-comment">-- | A representation of which function is being generated.</span><span>
</span><a name="line-1047"></a><span class="hs-keyword">data</span><span> </span><a name="BiFun"><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier">BiFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Bimap"><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier">Bimap</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Bifoldr"><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier">Bifoldr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="BifoldMap"><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier">BifoldMap</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Bitraverse"><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier">Bitraverse</span></a></a><span>
</span><a name="line-1048"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-1049"></a><span>
</span><a name="line-1050"></a><span class="hs-identifier">biFunConstName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1051"></a><a name="biFunConstName"><a href="Data.Bifunctor.TH.html#biFunConstName"><span class="hs-identifier">biFunConstName</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bimapConstValName"><span class="hs-identifier hs-var">bimapConstValName</span></a><span>
</span><a name="line-1052"></a><span class="hs-identifier">biFunConstName</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifoldrConstValName"><span class="hs-identifier hs-var">bifoldrConstValName</span></a><span>
</span><a name="line-1053"></a><span class="hs-identifier">biFunConstName</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifoldMapConstValName"><span class="hs-identifier hs-var">bifoldMapConstValName</span></a><span>
</span><a name="line-1054"></a><span class="hs-identifier">biFunConstName</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bitraverseConstValName"><span class="hs-identifier hs-var">bitraverseConstValName</span></a><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span class="hs-identifier">biClassName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1057"></a><a name="biClassName"><a href="Data.Bifunctor.TH.html#biClassName"><span class="hs-identifier">biClassName</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifunctorTypeName"><span class="hs-identifier hs-var">bifunctorTypeName</span></a><span>
</span><a name="line-1058"></a><span class="hs-identifier">biClassName</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifoldableTypeName"><span class="hs-identifier hs-var">bifoldableTypeName</span></a><span>
</span><a name="line-1059"></a><span class="hs-identifier">biClassName</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier hs-var">Bitraversable</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bitraversableTypeName"><span class="hs-identifier hs-var">bitraversableTypeName</span></a><span>
</span><a name="line-1060"></a><span>
</span><a name="line-1061"></a><span class="hs-identifier">biFunName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1062"></a><a name="biFunName"><a href="Data.Bifunctor.TH.html#biFunName"><span class="hs-identifier">biFunName</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bimapValName"><span class="hs-identifier hs-var">bimapValName</span></a><span>
</span><a name="line-1063"></a><span class="hs-identifier">biFunName</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifoldrValName"><span class="hs-identifier hs-var">bifoldrValName</span></a><span>
</span><a name="line-1064"></a><span class="hs-identifier">biFunName</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bifoldMapValName"><span class="hs-identifier hs-var">bifoldMapValName</span></a><span>
</span><a name="line-1065"></a><span class="hs-identifier">biFunName</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#bitraverseValName"><span class="hs-identifier hs-var">bitraverseValName</span></a><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span class="hs-identifier">biClassToFuns</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span class="hs-special">]</span><span>
</span><a name="line-1068"></a><a name="biClassToFuns"><a href="Data.Bifunctor.TH.html#biClassToFuns"><span class="hs-identifier">biClassToFuns</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span class="hs-special">]</span><span>
</span><a name="line-1069"></a><span class="hs-identifier">biClassToFuns</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span class="hs-special">,</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span class="hs-special">]</span><span>
</span><a name="line-1070"></a><span class="hs-identifier">biClassToFuns</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier hs-var">Bitraversable</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span class="hs-special">]</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span class="hs-identifier">biFunToClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span>
</span><a name="line-1073"></a><a name="biFunToClass"><a href="Data.Bifunctor.TH.html#biFunToClass"><span class="hs-identifier">biFunToClass</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span>
</span><a name="line-1074"></a><span class="hs-identifier">biFunToClass</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>
</span><a name="line-1075"></a><span class="hs-identifier">biFunToClass</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>
</span><a name="line-1076"></a><span class="hs-identifier">biFunToClass</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier hs-var">Bitraversable</span></a><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span class="hs-identifier">biClassConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1079"></a><a name="biClassConstraint"><a href="Data.Bifunctor.TH.html#biClassConstraint"><span class="hs-identifier">biClassConstraint</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span>     </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#functorTypeName"><span class="hs-identifier hs-var">functorTypeName</span></a><span>
</span><a name="line-1080"></a><span class="hs-identifier">biClassConstraint</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span>    </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#foldableTypeName"><span class="hs-identifier hs-var">foldableTypeName</span></a><span>
</span><a name="line-1081"></a><span class="hs-identifier">biClassConstraint</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraversable"><span class="hs-identifier hs-var">Bitraversable</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#traversableTypeName"><span class="hs-identifier hs-var">traversableTypeName</span></a><span>
</span><a name="line-1082"></a><span class="hs-identifier">biClassConstraint</span><span> </span><a name="local-1627451535"><a href="#local-1627451535"><span class="hs-identifier">biClass</span></a></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biClassName"><span class="hs-identifier hs-var">biClassName</span></a><span> </span><a href="#local-1627451535"><span class="hs-identifier hs-var">biClass</span></a><span>
</span><a name="line-1083"></a><span class="hs-identifier">biClassConstraint</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1084"></a><span>
</span><a name="line-1085"></a><span class="hs-identifier">biFunArity</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1086"></a><a name="biFunArity"><a href="Data.Bifunctor.TH.html#biFunArity"><span class="hs-identifier">biFunArity</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>      </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#fmapValName"><span class="hs-identifier hs-var">fmapValName</span></a><span>
</span><a name="line-1087"></a><span class="hs-identifier">biFunArity</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>    </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#foldrValName"><span class="hs-identifier hs-var">foldrValName</span></a><span>
</span><a name="line-1088"></a><span class="hs-identifier">biFunArity</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>  </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#foldMapValName"><span class="hs-identifier hs-var">foldMapValName</span></a><span>
</span><a name="line-1089"></a><span class="hs-identifier">biFunArity</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#traverseValName"><span class="hs-identifier hs-var">traverseValName</span></a><span>
</span><a name="line-1090"></a><span class="hs-identifier">biFunArity</span><span> </span><a name="local-1627451536"><a href="#local-1627451536"><span class="hs-identifier">biFun</span></a></a><span>      </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Bifunctor.TH.html#biFunName"><span class="hs-identifier hs-var">biFunName</span></a><span> </span><a href="#local-1627451536"><span class="hs-identifier hs-var">biFun</span></a><span>
</span><a name="line-1091"></a><span class="hs-identifier">biFunArity</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1092"></a><span>
</span><a name="line-1093"></a><span class="hs-identifier">allowFunTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1094"></a><a name="allowFunTys"><a href="Data.Bifunctor.TH.html#allowFunTys"><span class="hs-identifier">allowFunTys</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifunctor"><span class="hs-identifier hs-var">Bifunctor</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1095"></a><span class="hs-identifier">allowFunTys</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span class="hs-identifier">allowExQuant</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiClass"><span class="hs-identifier hs-type">BiClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1098"></a><a name="allowExQuant"><a href="Data.Bifunctor.TH.html#allowExQuant"><span class="hs-identifier">allowExQuant</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifoldable"><span class="hs-identifier hs-var">Bifoldable</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1099"></a><span class="hs-identifier">allowExQuant</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1100"></a><span>
</span><a name="line-1101"></a><span class="hs-comment">-- See Trac #7436 for why explicit lambdas are used</span><span>
</span><a name="line-1102"></a><span class="hs-identifier">biFunTriv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1103"></a><a name="biFunTriv"><a href="Data.Bifunctor.TH.html#biFunTriv"><span class="hs-identifier">biFunTriv</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1104"></a><span>  </span><a name="local-1627451537"><a href="#local-1627451537"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-1105"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451537"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451537"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1106"></a><span class="hs-comment">-- The biFunTriv definitions for bifoldr, bifoldMap, and bitraverse might seem</span><span>
</span><a name="line-1107"></a><span class="hs-comment">-- useless, but they do serve a purpose.</span><span>
</span><a name="line-1108"></a><span class="hs-comment">-- See Note [biFunTriv for Bifoldable and Bitraversable]</span><span>
</span><a name="line-1109"></a><span class="hs-identifier">biFunTriv</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1110"></a><span>  </span><a name="local-1627451538"><a href="#local-1627451538"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-1111"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">wildP</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451538"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451538"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-1112"></a><span class="hs-identifier">biFunTriv</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">wildP</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#memptyValName"><span class="hs-identifier hs-var">memptyValName</span></a><span>
</span><a name="line-1113"></a><span class="hs-identifier">biFunTriv</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#pureValName"><span class="hs-identifier hs-var">pureValName</span></a><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span class="hs-identifier">biFunApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1116"></a><a name="biFunApp"><a href="Data.Bifunctor.TH.html#biFunApp"><span class="hs-identifier">biFunApp</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span> </span><a name="local-1627451539"><a href="#local-1627451539"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1117"></a><span>  </span><a name="local-1627451540"><a href="#local-1627451540"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-1118"></a><span>  </span><a name="local-1627451541"><a href="#local-1627451541"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-1119"></a><span>  </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451540"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451541"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">[</span><a href="#local-1627451539"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451541"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451540"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-1120"></a><span class="hs-identifier">biFunApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451542"><a href="#local-1627451542"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627451542"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-identifier">biFunCombine</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Bifunctor.TH.html#BiFun"><span class="hs-identifier hs-type">BiFun</span></a><span>
</span><a name="line-1123"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1124"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1125"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1126"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-1127"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1128"></a><a name="biFunCombine"><a href="Data.Bifunctor.TH.html#biFunCombine"><span class="hs-identifier">biFunCombine</span></a></a><span> </span><a href="Data.Bifunctor.TH.html#Bimap"><span class="hs-identifier hs-var">Bimap</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#bimapCombine"><span class="hs-identifier hs-var">bimapCombine</span></a><span>
</span><a name="line-1129"></a><span class="hs-identifier">biFunCombine</span><span> </span><a href="Data.Bifunctor.TH.html#Bifoldr"><span class="hs-identifier hs-var">Bifoldr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#bifoldrCombine"><span class="hs-identifier hs-var">bifoldrCombine</span></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">biFunCombine</span><span> </span><a href="Data.Bifunctor.TH.html#BifoldMap"><span class="hs-identifier hs-var">BifoldMap</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#bifoldMapCombine"><span class="hs-identifier hs-var">bifoldMapCombine</span></a><span>
</span><a name="line-1131"></a><span class="hs-identifier">biFunCombine</span><span> </span><a href="Data.Bifunctor.TH.html#Bitraverse"><span class="hs-identifier hs-var">Bitraverse</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.html#bitraverseCombine"><span class="hs-identifier hs-var">bitraverseCombine</span></a><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><span class="hs-identifier">bimapCombine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1134"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1135"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1136"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-1137"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1138"></a><a name="bimapCombine"><a href="Data.Bifunctor.TH.html#bimapCombine"><span class="hs-identifier">bimapCombine</span></a></a><span> </span><a name="local-1627451543"><a href="#local-1627451543"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier hs-var">AppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConE</span><span> </span><a href="#local-1627451543"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#fromEither"><span class="hs-identifier hs-var">fromEither</span></a><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span class="hs-comment">-- bifoldr, bifoldMap, and bitraverse are handled differently from bimap, since</span><span>
</span><a name="line-1141"></a><span class="hs-comment">-- they filter out subexpressions whose types do not mention one of the last two</span><span>
</span><a name="line-1142"></a><span class="hs-comment">-- type parameters. See</span><span>
</span><a name="line-1143"></a><span class="hs-comment">-- https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/DeriveFunctor#AlternativestrategyforderivingFoldableandTraversable</span><span>
</span><a name="line-1144"></a><span class="hs-comment">-- for further discussion.</span><span>
</span><a name="line-1145"></a><span>
</span><a name="line-1146"></a><span class="hs-identifier">bifoldrCombine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1147"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1148"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1149"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-1150"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1151"></a><a name="bifoldrCombine"><a href="Data.Bifunctor.TH.html#bifoldrCombine"><span class="hs-identifier">bifoldrCombine</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451544"><a href="#local-1627451544"><span class="hs-identifier">zName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">AppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="#local-1627451544"><span class="hs-identifier hs-var">zName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rights</span><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span class="hs-identifier">bifoldMapCombine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1154"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1155"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1156"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-1157"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1158"></a><a name="bifoldMapCombine"><a href="Data.Bifunctor.TH.html#bifoldMapCombine"><span class="hs-identifier">bifoldMapCombine</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-1627451545"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rights</span><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1160"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1161"></a><span>    </span><a name="local-1627451545"><a href="#local-1627451545"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#memptyValName"><span class="hs-identifier hs-var">memptyValName</span></a><span>
</span><a name="line-1162"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627451546"><a href="#local-1627451546"><span class="hs-identifier">es</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppE</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">AppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#mappendValName"><span class="hs-identifier hs-var">mappendValName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627451546"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span class="hs-identifier">bitraverseCombine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1165"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1166"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1167"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-1168"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1169"></a><a name="bitraverseCombine"><a href="Data.Bifunctor.TH.html#bitraverseCombine"><span class="hs-identifier">bitraverseCombine</span></a></a><span> </span><a name="local-1627451547"><a href="#local-1627451547"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627451548"><a href="#local-1627451548"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1627451549"><a href="#local-1627451549"><span class="hs-identifier">essQ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1170"></a><span>    </span><a name="local-1627451550"><a href="#local-1627451550"><span class="hs-identifier">ess</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627451549"><span class="hs-identifier hs-var">essQ</span></a><span>
</span><a name="line-1171"></a><span>
</span><a name="line-1172"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">argTysTyVarInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-1173"></a><span>        </span><a name="local-1627451551"><a href="#local-1627451551"><span class="hs-identifier">argTysTyVarInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#isRight"><span class="hs-identifier hs-var">isRight</span></a><span> </span><a href="#local-1627451550"><span class="hs-identifier hs-var">ess</span></a><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span>        </span><span class="hs-identifier">argsWithTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">argsWithoutTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1176"></a><span>        </span><span class="hs-special">(</span><a name="local-1627451552"><a href="#local-1627451552"><span class="hs-identifier">argsWithTyVar</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627451553"><a href="#local-1627451553"><span class="hs-identifier">argsWithoutTyVar</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#partitionByList"><span class="hs-identifier hs-var">partitionByList</span></a><span> </span><a href="#local-1627451551"><span class="hs-identifier hs-var">argTysTyVarInfo</span></a><span> </span><a href="#local-1627451548"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>        </span><span class="hs-identifier">conExpQ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1179"></a><span>        </span><a name="local-1627451554"><a href="#local-1627451554"><span class="hs-identifier">conExpQ</span></a></a><span>
</span><a name="line-1180"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-1627451552"><span class="hs-identifier hs-var">argsWithTyVar</span></a><span>
</span><a name="line-1181"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conE</span><span> </span><a href="#local-1627451547"><span class="hs-identifier hs-var">conName</span></a><span class="hs-glyph">:</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451553"><span class="hs-identifier hs-var">argsWithoutTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1182"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1183"></a><span>              </span><a name="local-1627451555"><a href="#local-1627451555"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#newNameList"><span class="hs-identifier hs-var">newNameList</span></a><span> </span><span class="hs-string">&quot;b&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627451548"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1184"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-1627451556"><a href="#local-1627451556"><span class="hs-identifier">bs'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a><span>  </span><a href="#local-1627451551"><span class="hs-identifier hs-var">argTysTyVarInfo</span></a><span> </span><a href="#local-1627451555"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1185"></a><span>                  </span><a name="local-1627451557"><a href="#local-1627451557"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#filterByLists"><span class="hs-identifier hs-var">filterByLists</span></a><span> </span><a href="#local-1627451551"><span class="hs-identifier hs-var">argTysTyVarInfo</span></a><span>
</span><a name="line-1186"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451555"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1627451548"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1187"></a><span>              </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-1627451556"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conE</span><span> </span><a href="#local-1627451547"><span class="hs-identifier hs-var">conName</span></a><span class="hs-glyph">:</span><a href="#local-1627451557"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span>    </span><a name="local-1627451558"><a href="#local-1627451558"><span class="hs-identifier">conExp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627451554"><span class="hs-identifier hs-var">conExpQ</span></a><span>
</span><a name="line-1190"></a><span>
</span><a name="line-1191"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-1192"></a><span>        </span><a name="local-1627451559"><a href="#local-1627451559"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#pureValName"><span class="hs-identifier hs-var">pureValName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppE</span><span class="hs-special">`</span><span> </span><a href="#local-1627451558"><span class="hs-identifier hs-var">conExp</span></a><span>
</span><a name="line-1193"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-1627451560"><a href="#local-1627451560"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">:</span><a name="local-1627451561"><a href="#local-1627451561"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627451562"><a href="#local-1627451562"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627451563"><a href="#local-1627451563"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">InfixE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627451562"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#apValName"><span class="hs-identifier hs-var">apValName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627451563"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1194"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="Data.Bifunctor.TH.Internal.html#fmapValName"><span class="hs-identifier hs-var">fmapValName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppE</span><span class="hs-special">`</span><span> </span><a href="#local-1627451558"><span class="hs-identifier hs-var">conExp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppE</span><span class="hs-special">`</span><span> </span><a href="#local-1627451560"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627451561"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-1627451559"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627451550"><span class="hs-identifier hs-var">ess</span></a><span>
</span><a name="line-1197"></a><span>
</span><a name="line-1198"></a><span class="hs-comment">{-
Note [biFunTriv for Bifoldable and Bitraversable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When deriving Bifoldable and Bitraversable, we filter out any subexpressions whose
type does not mention one of the last two type parameters. From this, you might
think that we don't need to implement biFunTriv for bifoldr, bifoldMap, or
bitraverse at all, but in fact we do need to. Imagine the following data type:

    data T a b = MkT a (T Int b)

In a derived Bifoldable T instance, you would generate the following bifoldMap
definition:

    bifoldMap f g (MkT a1 a2) = f a1 &lt;&gt; bifoldMap (\_ -&gt; mempty) g arg2

You need to fill in biFunTriv (\_ -&gt; mempty) as the first argument to the recursive
call to bifoldMap, since that is how the algorithm handles polymorphic recursion.
-}</span><span>
</span><a name="line-1216"></a></pre></body></html>